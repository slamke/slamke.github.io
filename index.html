<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="雁渡寒潭 风吹疏竹">
<meta property="og:url" content="http://slamke.github.io/index.html">
<meta property="og:site_name" content="雁渡寒潭 风吹疏竹">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="雁渡寒潭 风吹疏竹">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://slamke.github.io/"/>





  <title>雁渡寒潭 风吹疏竹</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">雁渡寒潭 风吹疏竹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">教练，我想打篮球</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/09/13/Spark-on-Yarn-为什么出现内存超界container被kill/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/Spark-on-Yarn-为什么出现内存超界container被kill/" itemprop="url">Spark on Yarn 为什么出现内存超界container被kill</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T14:36:24+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/13/Spark-on-Yarn-为什么出现内存超界container被kill/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/13/Spark-on-Yarn-为什么出现内存超界container被kill/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一个Executor对应一个JVM进程。 从Spark的角度看，Executor占用的内存分为两部分：<figure class="highlight plain"><figcaption><span>Memory）等。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```spark.driver.memory``` 和```spark.executor.memory``` 分别设置Spark的Driver和Executor的```ExecutorMemory```.</span><br><span class="line"></span><br><span class="line">```spark.yarn.executor.memoryOverhead```和```spark.yarn.driver.memoryOverhead```分别设置Spark的Driver和Executor的```MemoryOverhead```.</span><br><span class="line"></span><br><span class="line">另外，Spark会大量分配堆外内存，堆外内存默认最大可以和```ExecutorMemory```一样，可以通过javaOptions使用```MaxDirectMemorySize```配置最大值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">堆外内存最大可以和```ExecutorMemory```一样，但是堆外内存又受```MemoryOverhead```限制，所以当```MaxDirectMemorySize```,```ExecutorMemory```和```MemoryOverhead```设置不合理时，会出现container内存超限，被Yarn kill的情况。 </span><br><span class="line"></span><br><span class="line">比如，```ExecutorMemory``` 为8G，```MemoryOverhead```为4G，```MaxDirectMemorySize```没有设置，此时yarn认为一个container最大可以使用12G内存，但是堆外内存最大可以使用8G，导致container最大可以使用超过16G内存(堆内内存+ 堆外内存)，比12G大， 最终被Yarn kill掉。</span><br><span class="line"></span><br><span class="line">合理的设置规则为:    ```ExecutorMemory``` + ```MemoryOverhead``` &gt;  ```ExecutorMemory``` + ```MaxDirectMemorySize</span><br></pre></td></tr></table></figure></p>
<p>所以，Spark应用占用集群内存的总大小为: </p>
<blockquote>
<p>(executor个数) * (SPARK_EXECUTOR_MEMORY+ spark.yarn.executor.memoryOverhead)+(SPARK_DRIVER_MEMORY+spark.yarn.driver.memoryOverhead)</p>
</blockquote>
<p>参数调优建议：</p>
<p>每个Executor进程的内存设置4G~8G较为合适。</p>
<p>每个Executor的CPU core数量设置为2~4个较为合适。</p>
<p>以下是部分建议的参数设置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--conf "spark.driver.extraJavaOptions=-XX:MaxDirectMemorySize=1024m -Xmn4g -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/tmp/log/run/gc-%t.log" \</span><br><span class="line"></span><br><span class="line">--conf "spark.speculation=true" \</span><br><span class="line">--conf "spark.speculation.quantile=0.95" \</span><br><span class="line"></span><br><span class="line">--conf "spark.kryoserializer.buffer.max=1024m" \</span><br><span class="line"></span><br><span class="line">--conf "spark.sql.hive.metastorePartitionPruning=true" \</span><br><span class="line">--conf "spark.sql.optimizer.metadataOnly=true" \</span><br><span class="line">--conf "spark.sql.parquet.filterPushdown=true" \</span><br><span class="line">--conf "spark.sql.hive.caseSensitiveInferenceMode=NEVER_INFER" \</span><br><span class="line">--conf "spark.sql.hive.convertMetastoreParquet=false" \</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/09/07/redis系列：通过文章点赞排名案例学习sortedset命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/redis系列：通过文章点赞排名案例学习sortedset命令/" itemprop="url">redis系列：通过文章点赞排名案例学习sortedset命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-07T15:17:07+08:00">
                2018-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/07/redis系列：通过文章点赞排名案例学习sortedset命令/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/07/redis系列：通过文章点赞排名案例学习sortedset命令/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://cloud.tencent.com/developer/article/1197195" target="_blank" rel="noopener">redis系列：通过文章点赞排名案例学习sortedset命令</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/09/07/JVM源码分析之SystemGC完全解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/JVM源码分析之SystemGC完全解读/" itemprop="url">JVM源码分析之SystemGC完全解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-07T14:51:40+08:00">
                2018-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/07/JVM源码分析之SystemGC完全解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/07/JVM源码分析之SystemGC完全解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="JVM源码分析之SystemGC完全解读"><a href="#JVM源码分析之SystemGC完全解读" class="headerlink" title="JVM源码分析之SystemGC完全解读"></a>JVM源码分析之SystemGC完全解读</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>JVM的GC一般情况下是JVM本身根据一定的条件触发的，不过我们还是可以做一些人为的触发，比如通过jvmti做强制GC，通过System.gc触发，还可以通过jmap来触发等，针对每个场景其实我们都可以写篇文章来做一个介绍，本文重点介绍下System.gc的原理</p>
<p>或许大家已经知道如下相关的知识</p>
<ul>
<li>system.gc其实是做一次full gc</li>
<li>system.gc会暂停整个进程</li>
<li>system.gc一般情况下我们要禁掉，使用-XX:+DisableExplicitGC</li>
<li>system.gc在cms gc下我们通过-XX:+ExplicitGCInvokesConcurrent来做一次稍微高效点的GC(效果比Full GC要好些)</li>
<li>system.gc最常见的场景是RMI/NIO下的堆外内存分配等</li>
</ul>
<p>如果你已经知道上面这些了其实也说明你对System.gc有过一定的了解，至少踩过一些坑，但是你是否更深层次地了解过它，比如</p>
<ul>
<li>为什么CMS GC下-XX:+ExplicitGCInvokesConcurrent这个参数加了之后会比真正的Full GC好？</li>
<li>它如何做到暂停整个进程？</li>
<li>堆外内存分配为什么有时候要配合System.gc？</li>
</ul>
<p>如果你上面这些疑惑也都知道，那说明你很懂System.gc了，那么接下来的文字你可以不用看啦</p>
<h2 id="JDK里的System-gc的实现"><a href="#JDK里的System-gc的实现" class="headerlink" title="JDK里的System.gc的实现"></a>JDK里的System.gc的实现</h2><p>先贴段代码吧（java.lang.System）</p>
<p>发现主要调用的是Runtime里的gc方法（java.lang.Runtime）</p>
<p>这里看到gc方法是native的，在java层面只能到此结束了，代码只有这么多，要了解更多，可以看方法上面的注释，不过我们需要更深层次地来了解其实现，那还是准备好进入到jvm里去看看</p>
<h2 id="Hotspot里System-gc的实现"><a href="#Hotspot里System-gc的实现" class="headerlink" title="Hotspot里System.gc的实现"></a>Hotspot里System.gc的实现</h2><h3 id="如何找到native里的实现"><a href="#如何找到native里的实现" class="headerlink" title="如何找到native里的实现"></a>如何找到native里的实现</h3><p>上面提到了Runtime.gc是一个本地方法，那需要先在jvm里找到对应的实现，这里稍微提一下jvm里native方法最常见的也是最简单的查找，jdk里一般含有native方法的类，一般都会有一个对应的c文件，比如上面的java.lang.Runtime这个类，会有一个Runtime.c的文件和它对应，native方法的具体实现都在里面了，如果你有source，可能会猜到和下面的方法对应</p>
<p>其实没错的，就是这个方法，jvm要查找到这个native方法其实很简单的，看方法名可能也猜到规则了，Java_pkgName_className_methodName，其中pkgName里的”.“替换成”_“，这样就能找到了，当然规则不仅仅只有这么一个，还有其他的，这里不细说了，有机会写篇文章详细介绍下其中细节</p>
<h3 id="DisableExplicitGC参数"><a href="#DisableExplicitGC参数" class="headerlink" title="DisableExplicitGC参数"></a>DisableExplicitGC参数</h3><p>上面的方法里是调用JVM_GC()，实现如下</p>
<p>看到这里我们已经解释其中一个疑惑了，就是<code>DisableExplicitGC</code>这个参数是在哪里生效的，起的什么作用，如果这个参数设置为true的话，那么将直接跳过下面的逻辑，我们通过-XX:+ DisableExplicitGC就是将这个属性设置为true，而这个属性默认情况下是true还是false呢</p>
<h3 id="ExplicitGCInvokesConcurrent参数"><a href="#ExplicitGCInvokesConcurrent参数" class="headerlink" title="ExplicitGCInvokesConcurrent参数"></a>ExplicitGCInvokesConcurrent参数</h3><p>这里主要针对CMSGC下来做分析，所以我们上面看到调用了heap的collect方法，我们找到对应的逻辑</p>
<p>collect里一开头就有个判断，如果should_do_concurrent_full_gc返回true，那会执行collect_mostly_concurrent做并行的回收</p>
<p>其中should_do_concurrent_full_gc中的逻辑是如果使用CMS GC，并且是system gc且ExplicitGCInvokesConcurrent==true，那就做并行full gc，当我们设置-XX:+ ExplicitGCInvokesConcurrent的时候，就意味着应该做并行Full GC了，不过要注意千万不要设置-XX:+DisableExplicitGC，不然走不到这个逻辑里来了</p>
<h2 id="并行Full-GC相对正常的Full-GC效率高在哪里"><a href="#并行Full-GC相对正常的Full-GC效率高在哪里" class="headerlink" title="并行Full GC相对正常的Full GC效率高在哪里"></a>并行Full GC相对正常的Full GC效率高在哪里</h2><h3 id="stop-the-world"><a href="#stop-the-world" class="headerlink" title="stop the world"></a>stop the world</h3><p>说到GC，这里要先提到VMThread，在jvm里有这么一个线程不断轮询它的队列，这个队列里主要是存一些VM_operation的动作，比如最常见的就是内存分配失败要求做GC操作的请求等，在对gc这些操作执行的时候会先将其他业务线程都进入到安全点，也就是这些线程从此不再执行任何字节码指令，只有当出了安全点的时候才让他们继续执行原来的指令，因此这其实就是我们说的stop the world(STW)，整个进程相当于静止了</p>
<h3 id="CMS-GC"><a href="#CMS-GC" class="headerlink" title="CMS GC"></a>CMS GC</h3><p>这里必须提到CMS GC，因为这是解释并行Full GC和正常Full GC的关键所在，CMS GC我们分为两种模式background和foreground，其中background顾名思义是在后台做的，也就是可以不影响正常的业务线程跑，触发条件比如说old的内存占比超过多少的时候就可能触发一次background式的cms gc，这个过程会经历CMS GC的所有阶段，该暂停的暂停，该并行的并行，效率相对来说还比较高，毕竟有和业务线程并行的gc阶段；而foreground则不然，它发生的场景比如业务线程请求分配内存，但是内存不够了，于是可能触发一次cms gc，这个过程就必须是要等内存分配到了线程才能继续往下面走的，因此整个过程必须是STW的，因此CMS GC整个过程都是暂停应用的，但是为了提高效率，它并不是每个阶段都会走的，只走其中一些阶段，这些省下来的阶段主要是并行阶段，Precleaning、AbortablePreclean，Resizing这几个阶段都不会经历，其中sweep阶段是同步的，但不管怎么说如果走了类似foreground的cms gc，那么整个过程业务线程都是不可用的，效率会影响挺大。CMS GC具体的过程后面再写文章详细说，其过程确实非常复杂的</p>
<h3 id="正常的Full-GC"><a href="#正常的Full-GC" class="headerlink" title="正常的Full GC"></a>正常的Full GC</h3><p>正常的Full GC其实是整个gc过程包括ygc和cms gc(这里说的是真正意义上的Full GC，还有些场景虽然调用Full GC的接口，但是并不会都做，有些时候只做ygc，有些时候只做cms gc)都是由VMThread来执行的，因此整个时间是ygc+cms gc的时间之和，其中CMS GC是上面提到的foreground式的，因此整个过程会比较长，也是我们要避免的</p>
<h3 id="并行的Full-GC"><a href="#并行的Full-GC" class="headerlink" title="并行的Full GC"></a>并行的Full GC</h3><p>并行Full GC也通样会做YGC和CMS GC，但是效率高就搞在CMS GC是走的background的，整个暂停的过程主要是YGC+CMS_initMark+CMS_remark几个阶段</p>
<h2 id="堆外内存常配合使用System-GC"><a href="#堆外内存常配合使用System-GC" class="headerlink" title="堆外内存常配合使用System GC"></a>堆外内存常配合使用System GC</h2><p>这里说的堆外内存主要针对java.nio.DirectByteBuffer，这些对象的创建过程会通过Unsafe接口直接通过os::malloc来分配内存，然后将内存的起始地址和大小存到java.nio.DirectByteBuffer对象里，这样就可以直接操作这些内存。这些内存只有在DirectByteBuffer回收掉之后才有机会被回收，因此如果这些对象大部分都移到了old，但是一直没有触发CMS GC或者Full GC，那么悲剧将会发生，因为你的物理内存被他们耗尽了，因此为了避免这种悲剧的发生，通过-XX:MaxDirectMemorySize来指定最大的堆外内存大小，当使用达到了阈值的时候将调用System.gc来做一次full gc，以此来回收掉没有被使用的堆外内存，具体堆外内存是如何回收的，其原理机制又是怎样的，还是后面写篇详细的文章吧</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/09/07/Minor-GC、Major-GC和Full-GC之间的区别/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/Minor-GC、Major-GC和Full-GC之间的区别/" itemprop="url">Minor GC、Major GC和Full GC之间的区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-07T12:26:42+08:00">
                2018-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/07/Minor-GC、Major-GC和Full-GC之间的区别/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/07/Minor-GC、Major-GC和Full-GC之间的区别/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.importnew.com/15820.html" target="_blank" rel="noopener">Minor GC、Major GC和Full GC之间的区别</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/08/23/JMC和JCMD使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/JMC和JCMD使用/" itemprop="url">JMC和JCMD使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-23T11:11:47+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/23/JMC和JCMD使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/23/JMC和JCMD使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://sufuq.com/post/%E4%BD%BF%E7%94%A8jcmd%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">使用JCMD排查问题</a></p>
<p><a href="http://calvin1978.blogcn.com/articles/perf-tunning-1.html" target="_blank" rel="noopener">另一份Java应用调优指南之－前菜</a></p>
<p><a href="http://calvin1978.blogcn.com/articles/perf-tunning-2.html" target="_blank" rel="noopener">另一份Java应用调优指南之－工具篇</a></p>
<p><a href="http://zclau.com/2016/09/04/Java-Mission-Control%E4%B9%8B%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Java Mission Control之使用</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote=true </span><br><span class="line">-Djava.rmi.server.hostname=** </span><br><span class="line">-Dcom.sun.management.jmxremote.port=6666 </span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=false </span><br><span class="line">-Dcom.sun.managementote.ssl=false </span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=false </span><br><span class="line"><span class="meta">#</span> 下面是 Java Flight Recorder 取样分析</span><br><span class="line">-XX:+UnlockCommercialFeatures </span><br><span class="line">-XX:+FlightRecorder</span><br></pre></td></tr></table></figure>
<p>Javacpu 和内存问题排查步骤: </p>
<ol>
<li>ps ux 查看运行的进程</li>
<li>top -c查看占用cpu的进程</li>
<li>top -bn1 -H -p <pid>  / top -Hp <pid>查看占用cpu的线程  // 找出cpu高的线程tid ps -mp <pid> -o THREAD,tid,time | sort -rn</pid></pid></pid></li>
<li>jstack <pid>查看线程运行情况  // 转换线程tidprintf “%x\n” <tid></tid></pid></li>
<li>jmap -heap <pid> 查看内存占用情况</pid></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/08/23/JDK的bin下的工具有哪些功能/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/JDK的bin下的工具有哪些功能/" itemprop="url">JDK的bin下的工具有哪些功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-23T11:08:23+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/23/JDK的bin下的工具有哪些功能/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/23/JDK的bin下的工具有哪些功能/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.wangtianyi.top/blog/2018/07/20/javasheng-chan-huan-jing-xia-wen-ti-pai-cha/" target="_blank" rel="noopener">Java生产环境下问题排查</a></p>
<p><a href="http://lovestblog.cn/blog/2016/07/20/jstat/" target="_blank" rel="noopener">JVM源码分析之Jstat工具原理完全解读</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/19/33151873.html" target="_blank" rel="noopener">Java内存泄漏分析系列之一：使用jstack定位线程堆栈信息</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/19/51301886.html" target="_blank" rel="noopener">Java内存泄漏分析系列之二：jstack生成的Thread Dump日志结构解析</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/20/12131956.html" target="_blank" rel="noopener">Java内存泄漏分析系列之三：jstat命令的使用及VM Thread分析</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/25/36441958.html" target="_blank" rel="noopener">Java内存泄漏分析系列之四：jstack生成的Thread Dump日志线程状态</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/26/08572060.html" target="_blank" rel="noopener">Java内存泄漏分析系列之五：常见的Thread Dump日志案例分析</a></p>
<p><a href="https://www.javatang.com/archives/2017/10/30/53562102.html" target="_blank" rel="noopener">Java内存泄漏分析系列之六：JVM Heap Dump（堆转储文件）的生成和MAT的使用</a></p>
<h3 id="查看JVM参数"><a href="#查看JVM参数" class="headerlink" title="查看JVM参数"></a>查看JVM参数</h3><p><code>jps -l</code> 查看所有正在运行的Java程序，同时显示启动类类名，获取到PID</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4706 org.apache.catalina.startup.Bootstrap</span><br><span class="line">5023 sun.tools.jps.Jps</span><br></pre></td></tr></table></figure>
<p><code>jinfo -flags PID</code> 查看运行时进程参数与JVM参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 28987, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.171-b11</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=3 -XX:InitialHeapSize=132120576 -XX:MaxHeapSize=2092957696 -XX:MaxNewSize=697303040 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=44040192 -XX:OldSize=88080384 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC</span><br><span class="line">Command line:  -Dspring.config.location=application.properties -Dspring.profiles.active=staging</span><br></pre></td></tr></table></figure>
<p><code>java -XX:+PrintFlagsFinal -version</code> 查看当前虚拟机默认JVM参数</p>
<h3 id="查看即时GC状态"><a href="#查看即时GC状态" class="headerlink" title="查看即时GC状态"></a>查看即时GC状态</h3><p><code>jstat -gc PID 1000 10</code> 每秒查看一次gc信息，共10次</p>
<p>输出比较多的参数，每个字段的解释参看 <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line">512.0  512.0   15.3   0.0    4416.0   1055.2   11372.0     7572.5   14720.0 14322.5 1664.0 1522.8     40    0.137   8      0.039    0.176</span><br></pre></td></tr></table></figure>
<p>期间可能碰到提示<code>sun.jvm.hotspot.runtime.VMVersionMismatchException: Supported versions are 24.181-b01. Target VM is 25.171-b11</code>的问题，原因在于安装了多个版本，使用<code>which</code>、<code>ls -l</code>可简介定位到与当前执行Java程序相同的Java版本</p>
<h3 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h3><p>内存泄露导致OOM？内存占用异常的高？这是生产环境常常出现的问题，Java提供dump文件供我们对内存里发生过的事情进行了记录，我们需要借助一些工具从中获取有价值的信息。</p>
<h4 id="导出Dump文件"><a href="#导出Dump文件" class="headerlink" title="导出Dump文件"></a>导出Dump文件</h4><ol>
<li>提前对Java程序加上这些<strong>参数</strong>印dump文件 <code>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=./</code></li>
<li>对正在运行的程序使用<strong>jmap</strong>：<code>jmap -dump:format=b,file=heap.hprof PID</code></li>
</ol>
<h4 id="分析Dump文件"><a href="#分析Dump文件" class="headerlink" title="分析Dump文件"></a>分析Dump文件</h4><p>如果Dump文件不太大的话，可以传到 <a href="http://heaphero.io/index.jsp" target="_blank" rel="noopener">http://heaphero.io/index.jsp</a> 来分析</p>
<p>文件比较大，且想进行更加系统的分析，推荐使用<a href="https://www.eclipse.org/mat/" target="_blank" rel="noopener">MAT</a>分析，有如下几种常用查看方式</p>
<ol>
<li>首页中的【Leak Suspects】能推测出问题所在</li>
<li>点击【Create a histogram from an arbitrary set of objects】查到所有对象的数量</li>
<li>右键点击某个对象【Merge Shortest Paths to GC Roots】-&gt; 【exclude all phantom/weak/soft etc. references】能查询到大量数量的某个对象是哪个GC ROOT引用的</li>
</ol>
<h3 id="线程问题"><a href="#线程问题" class="headerlink" title="线程问题"></a>线程问题</h3><p>任务长时间不退出？CPU 负载过高？很可能因为死循环或者死锁，导致某些线程一直执行不被中断，但是不报错是最烦人的，所以日志里看不到错误信息，并且又不能用dump文件分析，因为跟内存无关。这个时候就需要用线程分析工具来帮我们了。</p>
<h4 id="导出jstack文件"><a href="#导出jstack文件" class="headerlink" title="导出jstack文件"></a>导出jstack文件</h4><p>使用<code>jstack PID &gt; 文件</code>，如果失败请加<code>-F</code>参数，如果还失败请使用Java程序启动时使用的用户执行jstack</p>
<h4 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h4><ol>
<li><code>top</code> 查看到哪个java程序负载高</li>
<li><code>top -p PID -H</code> 查看该进程所有进程的运行状态</li>
<li>记录下高负载的线程ID，<code>printf &quot;&amp;x&quot; PID</code>转换成16进制</li>
<li><code>jstack PID &gt; 文件</code></li>
<li>在jstack文件中用转换成16进制之后的线程ID查询线程运行堆栈</li>
<li>从堆栈中了解到线程在执行什么任务，并结合业务与代码判断问题所在</li>
</ol>
<p>以下转载自:  <a href="http://www.codingwhy.com/view/858.html" target="_blank" rel="noopener">http://www.codingwhy.com/view/858.html</a></p>
<p>Java开发人员肯定都知道JDK的bin目录中有“java”、“javac”这两个命令行工具，但并非所有的程序员都了解过JDK的bin目录之中的其他工具的作用。</p>
<p>这些工具被Sun公司作为“礼物”附赠给JDK的使用者，并在软件的使用说明中把他们申明为“没有技术支持并且是试验性质的（unsupported and experimental）”的产品，但事实上，这些工具都非常的稳定且功能强大，能在处理应用程序性能问题、定位故障时发挥很大的作用。</p>
<p>细心的可能会发现，这些工具都非常小，是因为这些工具大多是jdk/lib/tools.jar类库的一层包装而已，他们主要的功能代码是在tools类库中实现的。</p>
<h2 id="Java故障检修，程序概要分析，监视和管理工具"><a href="#Java故障检修，程序概要分析，监视和管理工具" class="headerlink" title="Java故障检修，程序概要分析，监视和管理工具"></a>Java故障检修，程序概要分析，监视和管理工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>jvisualvm</td>
<td>一个图形化的Java虚拟机  参考: <a href="https://blog.csdn.net/a19881029/article/details/8432368" target="_blank" rel="noopener"> Java jvisualvm简要说明</a></td>
</tr>
<tr>
<td>jconsole</td>
<td>java监视台和管理控制台 参考: <a href="http://jiajun.iteye.com/blog/810150" target="_blank" rel="noopener">如何利用 JConsole观察分析Java程序的运行，进行排错调优</a>  <a href="https://www.ibm.com/support/knowledgecenter/zh/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/jconsole.html" target="_blank" rel="noopener">https://www.ibm.com/support/knowledgecenter/zh/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/jconsole.html</a></td>
</tr>
<tr>
<td>jps</td>
<td>JVM Process Status进程状态工具。列出目标系统的HotSpot JJVM  可以列出本机所有java进程的pid</td>
</tr>
<tr>
<td>jstat</td>
<td>按照命令行的具体要求记录和收集一个JVM的性能数据</td>
</tr>
<tr>
<td>jstatd</td>
<td>JVM jstat 的守护进程</td>
</tr>
<tr>
<td>jmc</td>
<td>Java任务控制工具(Java Mission Control)，主要用于HotSpot JVM的生产时间监测、分析、诊断。</td>
</tr>
</tbody>
</table>
<h2 id="故障检测和修理工具"><a href="#故障检测和修理工具" class="headerlink" title="故障检测和修理工具"></a>故障检测和修理工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>jinfo</td>
<td>配置或打印某个Java进程VM flag</td>
</tr>
<tr>
<td>jhat</td>
<td>堆储存查看器</td>
</tr>
<tr>
<td>jmap</td>
<td>Java内存图</td>
</tr>
<tr>
<td>jsadebugd</td>
<td>Java的 Serviceability Agent Debug的守护进程</td>
</tr>
<tr>
<td>jstack</td>
<td>Java堆栈跟踪</td>
</tr>
</tbody>
</table>
<p><a href="https://my.oschina.net/feichexia/blog/196575" target="_blank" rel="noopener">JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解</a></p>
<h2 id="基本工具"><a href="#基本工具" class="headerlink" title="基本工具"></a>基本工具</h2><p>这些工具是JDK的基础，用这些工具来编写应用程序。</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>javac</td>
<td>Java语言编译器</td>
</tr>
<tr>
<td>java</td>
<td>Java应用程序启动器</td>
</tr>
<tr>
<td>javaw</td>
<td>Java运行工具，用于运行.class字节码文件或.jar文件，但不会显示控制台输出信息，适用于运行图形化程序。</td>
</tr>
<tr>
<td>javadoc</td>
<td>Java API文档生成器</td>
</tr>
<tr>
<td>apt</td>
<td>java 注解处理器  <a href="https://www.jianshu.com/p/82093e5160ae" target="_blank" rel="noopener">「深入Java」Annotation注解</a></td>
</tr>
<tr>
<td>appletviewer</td>
<td>java applet小程序查看器</td>
</tr>
<tr>
<td>jar</td>
<td>java文件压缩打包工具</td>
</tr>
<tr>
<td>jdb</td>
<td>Java调试器</td>
</tr>
<tr>
<td>javah</td>
<td>C头文件和stub生成器，用于写本地化方法，例如生产JNI样式的头文件</td>
</tr>
<tr>
<td>javap</td>
<td>class文件反编译工具</td>
</tr>
<tr>
<td>extcheck</td>
<td>用于检测jar包中的问题</td>
</tr>
<tr>
<td>jcmd</td>
<td>Java命令行(Java Command)，用于向正在运行的JVM发送诊断命令请求。</td>
</tr>
</tbody>
</table>
<h2 id="安全工具"><a href="#安全工具" class="headerlink" title="安全工具"></a>安全工具</h2><p>这些工具用于设置系统的安全规则和生产可以工作在远端的安全规则下的应用程序</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>keytool</td>
<td>管理密钥库和证书</td>
</tr>
<tr>
<td>jarsigner</td>
<td>生产和校验JAR签名</td>
</tr>
<tr>
<td>policytool</td>
<td>有用户界面的规则管理工具</td>
</tr>
<tr>
<td>kinit</td>
<td>用于获得和缓存网络认证协议Kerberos 票证的授予票证</td>
</tr>
<tr>
<td>klist</td>
<td>凭据高速缓存和密钥表中的 Kerberos 显示条目</td>
</tr>
<tr>
<td>ktab</td>
<td>密钥和证书管理工具</td>
</tr>
</tbody>
</table>
<h2 id="Java国际化工具"><a href="#Java国际化工具" class="headerlink" title="Java国际化工具"></a>Java国际化工具</h2><p>这些工具可以帮助你创建可本地化的应用程序</p>
<p>native2ascii</p>
<h2 id="远程方法调用工具"><a href="#远程方法调用工具" class="headerlink" title="远程方法调用工具"></a>远程方法调用工具</h2><p>这些工具可以帮助创建可以和web和网络交互的应用程序</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>rmic</td>
<td>生成远程对象的stubs and skeletons(存根和框架)</td>
</tr>
<tr>
<td>rmid</td>
<td>Java远程方法调用(RMI:Remote Method Invocation)活化系统守护进程</td>
</tr>
<tr>
<td>rmiregistry</td>
<td>Java远程对象注册表</td>
</tr>
<tr>
<td>serialver</td>
<td>返回类的 serialVersionUID</td>
</tr>
<tr>
<td>java-rmi</td>
<td>Java远程方法调用(Java Remote Method Invocation)工具，主要用于在客户机上调用远程服务器上的对象</td>
</tr>
</tbody>
</table>
<h2 id="Java-IDL-and-RMI-IIOP-工具"><a href="#Java-IDL-and-RMI-IIOP-工具" class="headerlink" title="Java IDL and RMI-IIOP 工具"></a>Java IDL and RMI-IIOP 工具</h2><p>这些工具用于创建使用OMG-Standard IDL 和 CORBA/IIOP 的应用程序</p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>tnameserv</td>
<td>Java IDL瞬时命名服</td>
</tr>
<tr>
<td>idlj</td>
<td>生产映射到OMG IDL接口可以使Java应用程序使用CORBA的.java文件</td>
</tr>
<tr>
<td>orbd</td>
<td>为客户可以在CORBA环境下透明的定位和调用服务器的稳定的对象提供支持</td>
</tr>
<tr>
<td>servertool</td>
<td>为应用程序提供易于使用的接口用于注册，注销，启动，关闭服务器</td>
</tr>
</tbody>
</table>
<h2 id="Java部署工具"><a href="#Java部署工具" class="headerlink" title="Java部署工具"></a>Java部署工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>pack200</td>
<td>使用java gzip压缩工具将JAR文件转换为压缩的pack200文件，生产打包文件是高度压缩的JAR包，可以直接部署，减少下载时间</td>
</tr>
<tr>
<td>unpack200</td>
<td>解包pack200文件为JARs</td>
</tr>
</tbody>
</table>
<h2 id="Java-web工具"><a href="#Java-web工具" class="headerlink" title="Java web工具"></a>Java web工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>javaws</td>
<td>Java web 启动命令行工具</td>
</tr>
<tr>
<td>schemagen</td>
<td>Java构架的XML Schema生成器</td>
</tr>
<tr>
<td>wsgen</td>
<td>生成 JAX-WS</td>
</tr>
<tr>
<td>wsimport</td>
<td>生成 JAX-WS</td>
</tr>
<tr>
<td>xjc</td>
<td>绑定编译器</td>
</tr>
</tbody>
</table>
<h2 id="Java脚本工具"><a href="#Java脚本工具" class="headerlink" title="Java脚本工具"></a>Java脚本工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>jrunscript</td>
<td>运行脚本</td>
</tr>
</tbody>
</table>
<h2 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h2><table>
<thead>
<tr>
<th>工具名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>jabswitch</td>
<td>Java Access Bridge Switch的简称，用于控制Java访问桥的开/关。Java访问桥是一种技术，让Java应用程序实现Accessibility API，以供Microsoft Windows系统的辅助技术访问。</td>
</tr>
<tr>
<td>javafxpackager</td>
<td>JavaFX打包工具</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/02/27/实时流计算-SparkStreaming-Kafka-Redis-Exactly-once-实时去重/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/实时流计算-SparkStreaming-Kafka-Redis-Exactly-once-实时去重/" itemprop="url">实时流计算+SparkStreaming+Kafka+Redis+Exactly-once+实时去重</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-27T11:11:30+08:00">
                2018-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/27/实时流计算-SparkStreaming-Kafka-Redis-Exactly-once-实时去重/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/27/实时流计算-SparkStreaming-Kafka-Redis-Exactly-once-实时去重/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://lxw1234.com/archives/2018/02/901.htm" target="_blank" rel="noopener">http://lxw1234.com/archives/2018/02/901.htm</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/01/16/Spark遇到中文乱码问题如何解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/16/Spark遇到中文乱码问题如何解决/" itemprop="url">Spark遇到中文乱码问题如何解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-16T18:18:38+08:00">
                2018-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/16/Spark遇到中文乱码问题如何解决/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/16/Spark遇到中文乱码问题如何解决/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spark-遇到中文乱码问题如何解决？"><a href="#Spark-遇到中文乱码问题如何解决？" class="headerlink" title="Spark 遇到中文乱码问题如何解决？"></a>Spark 遇到中文乱码问题如何解决？</h1><ul>
<li><p>问题原因：<br>一般是spark平台机器环境编码设置问题</p>
</li>
<li><p>解决方法：</p>
</li>
</ul>
<ol>
<li><p>在spark-default中为executor加上-Dfile.encoding=UTF-8<br>spark/conf/spark-defaults.conf</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.executor.extraJavaOptions -XX:+UseParallelGC -XX:+UseParallelOldGC -XX:ParallelGCThreads=4 -XX:NewRatio=3 -XX:SurvivorRatio=3 -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintTenuringDistribution -XX:+PrintGCApplicationStoppedTime -Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure>
</li>
<li><p>在所有涉及到字节转换时，一定要指定编码方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String -&gt; Byte: </span><br><span class="line">string.getBytes(<span class="string">"UTF-8"</span>)</span><br><span class="line"></span><br><span class="line">Byte -&gt; String:</span><br><span class="line"><span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>)</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/01/16/Spark动态资源分配/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/16/Spark动态资源分配/" itemprop="url">Spark动态资源分配</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-16T17:36:32+08:00">
                2018-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/16/Spark动态资源分配/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/16/Spark动态资源分配/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Yarn模式下资源分配"><a href="#1-Yarn模式下资源分配" class="headerlink" title="1. Yarn模式下资源分配"></a>1. Yarn模式下资源分配</h2><p>在Yarn模式下，<strong>ResourceManager</strong>(以后简称RM)会为每一个应用程序分配固定数量的Executors(默认是2个，可通过–num-executors设置)，且为每个Executor分配固定的CPU和内存(默认1个CPU和512M内存，可通过-executor-memory and和–executor-cores设置 )不同应用程序的Executors之间是互相独立的，每个应用程序的Executors只负责自己的应用程序的任务运行和数据存储。每个Executor是一个独立的JVM进程，JVM之间内存是无法共享的。</p>
<h2 id="2-动态资源分配的简介"><a href="#2-动态资源分配的简介" class="headerlink" title="2. 动态资源分配的简介"></a>2. 动态资源分配的简介</h2><p>动态资源调度是在Spark1.2之后才开始加进去的，</p>
<p>①原理：当一个应用程序不需要使用资源，且后续没有资源申请的时候，它就将现有的资源交回给集群，这样集群便可以将资源分配给其他应用程序来使用。当该应用程序再次需要资源的时候就再去向集群申请。</p>
<p>②优点：当集群中有很多应用程序的时候可以提高集群的资源利用率，比如集群中有一个应用程序作为服务一直在执行，集群给他分配了12个CPU和8G内存， 默认情况下，该应用会一直占用12个CPU和8G内存的资源，直到程序结束，如果目前该应用程序运行不需要这么多的资源，资源处于空闲状态的时候，集群也 不会把该资源分配给其他的应用程序，从而造成的资源的浪费。所以使用动态资源分配可以提高资源利用率。</p>
<p>③缺点：动态资源分配的调度算法如果不合理可能造成应用程序的高延迟，一种情况是某个应用程序刚把资源交回给集群，下一刻就又需要使用资源，然后在去向集群申请。</p>
<h2 id="3-动态资源分配的配置"><a href="#3-动态资源分配的配置" class="headerlink" title="3. 动态资源分配的配置"></a>3. 动态资源分配的配置</h2><p>①修改配置文件spark-defaults.conf，添加如下内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spark.dynamicAllocation.enabled   true   //开启动态资源分配</span><br><span class="line">spark.shuffle.service.enabled     true   //启用External shuffle Service服务</span><br><span class="line">//shuffle.service是必须要启动的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">spark.dynamicAllocation.minExecutors 1  //每个Application最小分配的executor数</span><br><span class="line">spark.dynamicAllocation.maxExecutors 30  //每个Application最大并发分配的executor数</span><br><span class="line"></span><br><span class="line">spark.shuffle.service.port 7337 //Shuffle Service服务端口，必须和yarn-site中的一致</span><br><span class="line"></span><br><span class="line">spark.dynamicAllocation.schedulerBacklogTimeout 1s </span><br><span class="line">spark.dynamicAllocation.sustainedSchedulerBacklogTimeout 5s</span><br></pre></td></tr></table></figure></p>
<p>②在$SPARK_HOME/lib目录下找到spark-<version>-yarn-shuffle.jar文件,将该jar文件添加到NodeManager节点的classpath环境中。</version></p>
<p>③修改yarn-site.xml文件，设置如下参数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">...........</span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>spark_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services.spark_shuffle.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.spark.network.yarn.YarnShuffleService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>④重新启动NodeManager。保证每个NodeManager节点读能找到spark-1.3.0-yarn-shuffle.jar该文件，否则NodeManager无法启动。我就是因为这个原因，导致花了很长时间才调试通。</p>
<h2 id="4-资源分配策略"><a href="#4-资源分配策略" class="headerlink" title="4. 资源分配策略"></a>4. 资源分配策略</h2><p>资源的动态分配要求Spark在资源空闲的时候放弃Executors资源，在需要运行任务的时候申请Executors资源。但是很难预测一个即将放弃 Executors资源的应用程序下一刻是否会运行任务，或者一个刚申请的Executor在下一刻是否会处于空闲状态。</p>
<p>①请求策略</p>
<p>资源动态分配模式下，如果某个Spark应用程序有某些tasks处于等待运行状态时，该应用程序就会向集群申请更多的Executors资源，这意味着 集群为该应用程序分配的Executors资源不足以满足它提交的正在运行的，且还没有运行结束的tasks。Spark请求Executors采用的是 轮询的方式，当有tasks处于等待状态<code>spark.dynamicAllocation.schedulerBacklogTimeout</code>秒后会触发一次Executors请求，如果之后tasks一直处于等待状态，那么每隔<code>spark.dynamicAllocation.sustainedSchedulerBacklogTimeout</code>秒会触发一次Executors请求，每次轮询中申请的Executors个数以指数形式增长，比如第一个轮询申请1个Executor，之后会依次申请2，4，8…个Executors。</p>
<p>需要关注两点，一是谨慎申请Executors资源，以免申请到的Executors资源只有一小部分处于运行状态，其他的大部分处于空闲状态。二是充分利用申请到的Executors资源，以防止后续有大量Executors资源申请的情况出现。</p>
<p>②删除策略</p>
<p>当某个Spark应用程序的某个Executor处于空闲状态<code>spark.dynamicAllocation.executorIdleTimeout</code>秒后就会删除该Executor，注意，如果有task处于等待状态的时候，该Executor就不会处于空闲状态。</p>
<h2 id="5-如何有效的删除Executor"><a href="#5-如何有效的删除Executor" class="headerlink" title="5. 如何有效的删除Executor"></a>5. 如何有效的删除Executor</h2><p>在默认情况下，只有在Executor失败或者它所属的应用程序退出的情况下Executor才会结束，这两种情况下Executor的状态都不需要保 存，可以直接删除。在动态资源分配情况下，在Executor退出之前应用程序还在执行，所以在Executor的被删除之前需要将它的状态需要保存下 来，等下次执行Executor的时候可以重用。对于Shuffle保存Executor的状态尤其重要，在Shuffle阶段Executor会将 Map阶段的输出结果保存到本地文件系统中，然后在Reduce阶段其他的Executors会从该文件系统中读取Map阶段的输出结果。动态资源分配模 式下，一个Executor有可能在它的Shuffle还没有完成之前就将该Executor删除了，这就导致Shuffle阶段Executor保存的 文件在下次重新启动Executor的时候需要进行不必要的重新计算。</p>
<p>解决方法是使用额外的Shuffle Service，这个特性是在Spark1.2之后加进来的，Shuffle Service是运行在集群每个节点上的服务，它与Spark应用程序及其Executors是相互独立的，如果Shuffle Service在运行，Spark的Executors就会从Shuffle Service获取Shuffle阶段保存的文件，而不是去每个节点获取。这就意味着一个Executors被删除之后，它在Shuffle阶段的状态信 息还一直运行在Shuffle Service中。</p>
<h2 id="6-动态资源分配相关配置"><a href="#6-动态资源分配相关配置" class="headerlink" title="6. 动态资源分配相关配置"></a>6. 动态资源分配相关配置</h2><p>红色参数比较重要，在使用动态资源分配的时候最好自行设置。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>spark.dynamicAllocation.enabled</code></td>
<td>false</td>
<td>是否启动动态资源分配，默认不启动，目前只支持Yarn模式，Standalone和Mesoso暂不支持</td>
</tr>
<tr>
<td>spark.dynamicAllocation.executorIdleTimeout</td>
<td>600</td>
<td>如果某个Executor在该时间段内处于空闲状态，那么它将被删除，其所占用的资源将返还给集群</td>
</tr>
<tr>
<td><code>spark.dynamicAllocation.initialExecutors</code></td>
<td>spark.dynamicAllocation.minExecutors</td>
<td>动态资源分配启动时初始化的Executor的个数，默认情况下与spark.dynamicAllocation.minExecutors配置的值相同，如果启动动态资源分配，那么该值必须大于0，否则应用程序会因为没有资源而无法运行</td>
</tr>
<tr>
<td><code>spark.dynamicAllocation.maxExecutors</code></td>
<td>Integer.MAX_VALUE</td>
<td>动态资源分配的Executors的最大个数</td>
</tr>
<tr>
<td><code>spark.dynamicAllocation.minExecutors</code></td>
<td>0</td>
<td>分配的最小Executors个数，默认为0</td>
</tr>
<tr>
<td>spark.dynamicAllocation.schedulerBacklogTimeout</td>
<td>5</td>
<td>如果有tasks处于等待状态，多少秒后开始向集群申请Executors资源，默认是5秒</td>
</tr>
<tr>
<td>spark.dynamicAllocation.sustainedSchedulerBacklogTimeout</td>
<td>schedulerBacklogTimeout</td>
<td>如果申请的Executors资源无法满足当前Tasks的需求，那么采用轮询的方式向集群申请Executors资源，该值为轮询的时间间隔，默认值与schedulerBacklogTimeout相同</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2018/01/16/Spark-on-Yarn资源调度和作业调度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/16/Spark-on-Yarn资源调度和作业调度/" itemprop="url">Spark-on-Yarn资源调度和作业调度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-16T17:33:58+08:00">
                2018-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/16/Spark-on-Yarn资源调度和作业调度/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/16/Spark-on-Yarn资源调度和作业调度/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="作业调度"><a href="#作业调度" class="headerlink" title="作业调度"></a>作业调度</h2><p>Spark默认采取FIFO策略运行多个Jobs，它提供一个队列来保存已经提交的Jobs，如果队头的Job不需要占用所有的集群资源，那么后续的 Job可以立即运行，但是如果队头的Job需要占用所有的集群资源，且运行时间很长，那么即使后续的Job很小，也要等待前面的Job执行完后才可以执 行，这样就造成了大量的延迟。</p>
<p>Spark0.8+版本开始支持公平调度策略，在该策略下，Spark以round robin的方式为每个Job分配执行的Tasks，每个Job在同一时间都可以运行多个Tasks，Jobs之间是共享集群资源的。这就意味着当一个大 任务运行的同时，用户提交的小任务可以立即执行，且获得良好的响应时间，而不用去等待大任务的结束。</p>
<p>通过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">``` scala</span><br><span class="line">val conf = new SparkConf().setMaster(...).setAppName(...)</span><br><span class="line">conf.set(&quot;spark.scheduler.mode&quot;, &quot;FAIR&quot;)</span><br><span class="line">val sc = new SparkContext(conf)</span><br></pre></td></tr></table></figure></p>
<h3 id="1-公平调度池"><a href="#1-公平调度池" class="headerlink" title="1. 公平调度池"></a>1. 公平调度池</h3><p>Spark支持将不同的Jobs划分到不同的调度池中，可以为每个调度池设置不同的属性（比如权重），这样就可以将重要的Job分到高优先级的调度池中， 比如可以为每个用户创建一个调度池，并为每个用户划分相等的集群资源，而不用去管每个用户同时运行多少个Job。</p>
<p>如果用户没有设置公平调度池，默认情况下提交的任务被划分到default调度池中，可通过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">``` scala</span><br><span class="line">sc.setLocalProperty(&quot;spark.scheduler.pool&quot;, &quot;pool1&quot;)</span><br></pre></td></tr></table></figure></p>
<p>清除调度池<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.setLocalProperty(<span class="string">"spark.scheduler.pool"</span>, <span class="literal">null</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="2-默认调度池"><a href="#2-默认调度池" class="headerlink" title="2. 默认调度池"></a>2. 默认调度池</h3><p>默认情况下不同的调度池共享集群的资源，但在每个调度池内部，Job是以FIFO的方式运行的，比如为每个用户创建一个调度池，集群的资源平均分配给各个调度池，在调度池内部，每个Job按照FIFO的顺序运行。</p>
<h3 id="3-调度池的属性"><a href="#3-调度池的属性" class="headerlink" title="3. 调度池的属性"></a>3. 调度池的属性</h3><p>schedulingMode：调度池内部Job之间的调度顺序，FIFO或FAIR，默认是FIFO<br>weight：调度池的权重，默认是1，如果设置为2，那么它将获取相当于其他调度池2倍的资源。<br>minShare：最少满足资源数，默认是0，只有在满足每个调度池minShare资源数的基础之上，才会按照weight比例来获取额外的资源。</p>
<p>可创建一个类似于<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">``` scala</span><br><span class="line">conf.set(&quot;spark.scheduler.allocation.file&quot;, &quot;/path/to/file&quot;)</span><br><span class="line">   fairscheduler.xml.template文件内容</span><br></pre></td></tr></table></figure></p>
<p>fairscheduler.xml.template文件内容<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">allocations</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">"production"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FAIR<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>1<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>2<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">"test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FIFO<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>2<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>3<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">allocations</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h3><p>myFairScheduler.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">allocations</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">"onlinetestpool"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FAIR<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>2<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>7<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pool</span> <span class="attr">name</span>=<span class="string">"default"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schedulingMode</span>&gt;</span>FAIR<span class="tag">&lt;/<span class="name">schedulingMode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">weight</span>&gt;</span>1<span class="tag">&lt;/<span class="name">weight</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">minShare</span>&gt;</span>7<span class="tag">&lt;/<span class="name">minShare</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">allocations</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动Spark应用<br>spark-shell \<br>–conf spark.scheduler.mode=FAIR \<br>–conf spark.scheduler.pool=onlinetestpool \<br>–conf spark.scheduler.allocation.file=/home/spark/spark/conf/fairscheduler.xml</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sun Ke</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">104</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sun Ke</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Sunke.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
