<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="雁渡寒潭 风吹疏竹">
<meta property="og:url" content="http://slamke.github.io/page/3/index.html">
<meta property="og:site_name" content="雁渡寒潭 风吹疏竹">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="雁渡寒潭 风吹疏竹">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://slamke.github.io/page/3/"/>





  <title>雁渡寒潭 风吹疏竹</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">雁渡寒潭 风吹疏竹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">教练，我想打篮球</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/09/13/深入解析Spark中的RPC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/13/深入解析Spark中的RPC/" itemprop="url">深入解析Spark中的RPC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-13T11:51:40+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://zhuanlan.zhihu.com/p/28893155?hmsr=toutiao.io" target="_blank" rel="noopener">深入解析Spark中的RPC</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/09/12/维基百科简体中文语料的获取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/12/维基百科简体中文语料的获取/" itemprop="url">维基百科简体中文语料的获取</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-12T11:21:00+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ML/" itemprop="url" rel="index">
                    <span itemprop="name">ML</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://licstar.net/archives/262" target="_blank" rel="noopener">维基百科简体中文语料的获取</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/09/11/Kafka相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/11/Kafka相关/" itemprop="url">Kafka相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-11T18:14:42+08:00">
                2017-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kafka/" itemprop="url" rel="index">
                    <span itemprop="name">Kafka</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://zhuanlan.zhihu.com/p/25212966" target="_blank" rel="noopener">初识消息系统kafka</a></p>
<p><a href="http://matt33.com/2017/09/04/kafka-best-pratice/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="noopener">Kafka 最佳实践</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/25227580" target="_blank" rel="noopener">深入kafka生产消费模型</a></p>
<p><a href="Linkedin Camus，从Kafka到HDFS的数据传输管道">https://github.com/linkedin/camus</a></p>
<p><a href="https://fangyeqing.github.io/2016/12/01/Camus%E4%BB%8B%E7%BB%8D/" target="_blank" rel="noopener">Camus介绍</a></p>
<p><a href="http://blog.csdn.net/lmalds/article/details/53940549" target="_blank" rel="noopener">Gobblin–一个用于Hadoop的统一”数据抽取框架”</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/06/09/Spark-Dataframe使用教程和Tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/09/Spark-Dataframe使用教程和Tips/" itemprop="url">Spark Dataframe使用教程和Tips</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-09T11:36:23+08:00">
                2017-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Databricks官方文档"><a href="#Databricks官方文档" class="headerlink" title="Databricks官方文档"></a>Databricks官方文档</h2><p><a href="https://docs.databricks.com/spark/latest/dataframes-datasets/introduction-to-dataframes-scala.html#working-with-dataframes" target="_blank" rel="noopener">https://docs.databricks.com/spark/latest/dataframes-datasets/introduction-to-dataframes-scala.html#working-with-dataframes</a></p>
<p>内置函数 <a href="https://spark.apache.org/docs/2.0.2/api/java/org/apache/spark/sql/functions.html" target="_blank" rel="noopener">https://spark.apache.org/docs/2.0.2/api/java/org/apache/spark/sql/functions.html</a></p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li><p>数据的精度</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  org.apache.spark.sql.functions._</span><br><span class="line">schemaPeople.agg(sum(<span class="string">"today_pay"</span>).cast(<span class="type">DecimalType</span>(precision=<span class="number">38</span>, scale=<span class="number">9</span>))).alias(<span class="string">"today_pay_sum"</span>)</span><br><span class="line"><span class="comment">// precision 数据长度</span></span><br><span class="line"><span class="comment">// scale 小数长度</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>关联join的使用<br>官方的示例中，df.join(df2, ‘name’, ‘outer’)这种用法是错误的，<br>只能使用schemaPeople.as(“a”).join(schemaPeople.as(“b”), $”a.name” === $”b.name”, “outer”)，必须指明两个df join的字段</p>
</li>
<li><p>添加列<br>追加列信息，下一步处理时，必须使用val newDF = schemaPeople.withColumn(“add_col”, lit(“new col”))重新赋值</p>
</li>
<li>column的空值判断<br>NO：df.filter(col(‘xxx’) is not None)<br>YES：df.filter(col(‘xxx’).isNotNull())</li>
<li>column常量赋值<br>用lit()包装，如df.withColumn(“src”, lit(“mobile”))</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/06/01/hadoop的安全机制和审计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/01/hadoop的安全机制和审计/" itemprop="url">hadoop的安全机制和审计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-01T14:33:09+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hadoop的安全机制"><a href="#Hadoop的安全机制" class="headerlink" title="Hadoop的安全机制"></a>Hadoop的安全机制</h2><p><a href="http://dongxicheng.org/mapreduce/hadoop-security/" target="_blank" rel="noopener">Hadoop安全机制介绍</a></p>
<p>Hadoop安全机制现状<br>Hadoop 一直缺乏安全机制，主要表现在以下几个方面：</p>
<p>(1) User to Service</p>
<p>[1] Namenode或者jobtracker缺乏安全认证机制  Client的用户名和用户组名由自己指定。</p>
<p>[2] DataNode缺乏安全授权机制<br>用户只要知道某个block的blockID，便可以绕过namenode直接从datanode上读取该block；用户可以向任意datanode上写block。</p>
<p>[3] JobTracker缺乏安全授权机制<br>用户可以修改或者杀掉任意其他用户的作业；用户可以修改JobTracker的持久化状态。</p>
<p>(2) Service to service安全认证<br>Datanode与TaskTracker缺乏安全授权机制，这使得用户可以随意启动假的datanode和tasktracker，如：你可以直接到已经启动的某个TaskTracker上启动另外一个tasktracker：<br>./hadoop-daemon.sh start datanode</p>
<p>（3）磁盘或者通信连接没有经过加密</p>
<p><a href="http://dongxicheng.org/mapreduce/hadoop-kerberos-introduction/?replytocom=41615" target="_blank" rel="noopener">Hadoop Kerberos安全机制介绍</a><br><img src="http://dongxicheng.org/wp-content/uploads/2012/03/kerbores_work_process.jpg" alt=""></p>
<p><a href="http://dongxicheng.org/mapreduce-nextgen/hadoop-yarn-security/" target="_blank" rel="noopener">Hadoop 2.0 (YARN)中的安全机制概述</a></p>
<p>一般而言，系统安全机制由认证(authentication)和授权(authorization)两大部分构成。认证就是简单地对一个实体的身份进行判断；而授权则是向实体授予对数据资源和信息访问权限的决策过程。同Hadoop 1.0一样，Hadoop 2.0中的认证机制采用Kerbero和Token两种方案，而授权则是通过引入访问控制列表（Access Control List，ACL）实现的。</p>
<h2 id="Hadoop-2-0授权机制"><a href="#Hadoop-2-0授权机制" class="headerlink" title="Hadoop 2.0授权机制"></a>Hadoop 2.0授权机制</h2><ul>
<li>队列访问控制列表，例如提交程序和管理程序</li>
<li>应用程序访问控制列表</li>
<li>服务访问控制列表，例如查看和修改app</li>
</ul>
<h2 id="Hadoop的安全管理"><a href="#Hadoop的安全管理" class="headerlink" title="Hadoop的安全管理"></a>Hadoop的安全管理</h2><p>Hadoop生态安全管理框架Apache Ranger</p>
<p>Ranger是一个框架，用于Hadoop平台上的监控和全面的数据安全管理。</p>
<p>Apache Ranger有以下目标：</p>
<ul>
<li>集中安全管理，在中央UI中或使用REST API来管理所有与安全相关的任务。</li>
<li>使用Hadoop组件/工具执行特定行为（或操作）并通过中央管理工具来进行细粒度的授权管理。</li>
<li>标准化所有Hadoop组件的授权方法。</li>
<li>增强对不同授权方法的支持  如：基于角色的访问控制，基于属性的访问控制等。</li>
<li>在Hadoop的所有组件中集中审核用户访问和（与安全相关的）管理操作。</li>
</ul>
<p>Ranger的功能还包括动态策略（Dynamic Policies），当访问依赖于时间等动态因素时。它可以基于每天的不同时刻、IP地址或是地理位置对访问资源进行限制。</p>
<p>对于受支持的Hadoop组件，Ranger通过访问控制策略提供了一种标准的授权方法。作为标准，Ranger提供了一种集中式的组件，用于审计用户的访问行为和管理组件间的安全交互行为。</p>
<p>Ranger使用了一种基于属性的方法定义和强制实施安全策略。当与Apache Hadoop的数据治理解决方案和元数据仓储组件Apache Atlas一起使用时，它可以定义一种基于标签的安全服务，通过使用标签对文件和数据资产进行分类，并控制用户和用户组对一系列标签的访问。Ranger的功能还包括动态策略（Dynamic Policies），当访问依赖于时间等动态因素时。它可以基于每天的不同时刻、IP地址或是地理位置对访问资源进行限制。</p>
<p>参考：<br><a href="http://www.lpnote.com/2017/04/11/best-practices-in-hdfs-authorization-with-apache-ranger/" target="_blank" rel="noopener">Apache Ranger在HDFS中的最佳实践</a><br><a href="http://www.datastart.cn/tech/2016/05/12/ranger.html" target="_blank" rel="noopener"></a></p>
<h2 id="WebUI保护"><a href="#WebUI保护" class="headerlink" title="WebUI保护"></a>WebUI保护</h2><p>Apache Knox Gateway是一个用于hadoop安全的RESTful API Gateway，为Spark/Hadoop集群提供唯一的REST入口。Knox以类似防火墙的形式挡在Spark集群之前，接管所有用户请求（如WEB UI访问、HDFS内容查看、Hive/HBase数据操作等）。从拓扑上来说这种做法更清爽（相对Kerberos），但对内部集群的保护要求很高，因为一旦攻破了Knox层，不管资源还是数据都是光着屁股的。</p>
<p>Spark、HDFS等等都提供了Story Web UI，用户可以从Web上查看当前JOB的执行情况，也可以kill掉JOB。那么这个Web UI不应该所有人都可以访问，而应该只开放给管理员使用。默认Spark没有认证，能连接到这个集群上就可以访问Web UI，但通过Knox，可以在打开Web UI的时候先做认证，限制只有某些用户可以访问。 类似的，Knox还可以保护HDFS NN UI、Yarn UI等</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/05/26/Hive-Metadata存MySQL注释中文乱码的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/26/Hive-Metadata存MySQL注释中文乱码的问题/" itemprop="url">Hive Metadata存MySQL注释中文乱码的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-26T12:48:35+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hive/" itemprop="url" rel="index">
                    <span itemprop="name">Hive</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参考： <a href="http://gengqi88.iteye.com/blog/2040422" target="_blank" rel="noopener">http://gengqi88.iteye.com/blog/2040422</a></p>
<p>解决方案：数据库编码为latin1.将一下表的字段(涉及注释的字段都改)编码设定为UTF8<br>1、然后进入数据库执行以下5条SQL语句：<br>(1)修改表字段注解和表注解<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> COLUMNS_V2 <span class="keyword">modify</span> <span class="keyword">column</span> <span class="keyword">COMMENT</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> TABLE_PARAMS <span class="keyword">modify</span> <span class="keyword">column</span> PARAM_VALUE <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br></pre></td></tr></table></figure></p>
<p>(2) 修改分区字段注解：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> PARTITION_PARAMS  <span class="keyword">modify</span> <span class="keyword">column</span> PARAM_VALUE <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="built_in">character</span> <span class="keyword">set</span> utf8 ; </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> PARTITION_KEYS  <span class="keyword">modify</span> <span class="keyword">column</span> PKEY_COMMENT <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br></pre></td></tr></table></figure></p>
<p>(3)修改索引注解：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span>  INDEX_PARAMS  <span class="keyword">modify</span> <span class="keyword">column</span> PARAM_VALUE  <span class="built_in">varchar</span>(<span class="number">4000</span>) <span class="built_in">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line">``` </span><br><span class="line">2、修改hive连接mysql的连接为utf-8</span><br><span class="line">``` xml</span><br><span class="line">&lt;property&gt; </span><br><span class="line">  &lt;name&gt;&lt;/name&gt; </span><br><span class="line">  &lt;value&gt;jdbc:mysql://IP:3306/hive?createDatabaseIfNotExist=true&amp;amp;characterEncoding=UTF-8&lt;/value&gt; </span><br><span class="line">  &lt;description&gt;JDBC connect string for a JDBC metastore&lt;/description&gt; </span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></p>
<p>另参考：<br><a href="https://my.oschina.net/jackieyeah/blog/742088" target="_blank" rel="noopener">https://my.oschina.net/jackieyeah/blog/742088</a><br><a href="http://www.crazyant.net/1193.html" target="_blank" rel="noopener">http://www.crazyant.net/1193.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/05/15/Scala隐式转换和隐式参数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/15/Scala隐式转换和隐式参数/" itemprop="url">Scala隐式转换和隐式参数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-15T11:27:59+08:00">
                2017-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Scala/" itemprop="url" rel="index">
                    <span itemprop="name">Scala</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Scala的implicit功能很强大，可以自动地给对象”添加一个属性”。 这里打上引号的原因是Scala内部进行编译的时候会自动加上隐式转换函数。</p>
<p>很多Scala开源框架内部都大量使用了implicit。因为implicit真的很强大，写得好的implicit可以让代码更优雅。但个人感觉implicit也有一些缺点，比如使用了implicit之后，看源码或者使用一些library的时候无法下手，因为你根本不知道作者哪里写了implicit。这个也会对初学者造成一些困扰。</p>
<p>比如Scala中Option就有一个implicit可以将Option转换成Iterable：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">val</span> map = <span class="type">Map</span>(<span class="number">1</span> -&gt; <span class="number">11</span>, <span class="number">2</span> -&gt; <span class="number">22</span>, <span class="number">3</span> -&gt; <span class="number">33</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> newList = list.flatMap &#123;</span><br><span class="line">    num =&gt; map.get(num) <span class="comment">// map.get方法返回的是Option，可以被隐式转换成Iterable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是implicit的一个小例子。</p>
<p>比如以下一个例子，定义一个Int类型的变量num，但是赋值给了一个Double类型的数值。这时候就会编译错误：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> num: <span class="type">Int</span> = <span class="number">3.5</span> <span class="comment">// Compile Error</span></span><br></pre></td></tr></table></figure>
<p>但是我们加了一个隐式转换之后，就没问题了:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">double2Int</span></span>(d: <span class="type">Double</span>) = d.toInt</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> num: <span class="type">Int</span> = <span class="number">3.5</span> <span class="comment">// 3， 这段代码会被编译成 val num: Int = double2Int(3.5)</span></span><br></pre></td></tr></table></figure>
<h2 id="隐式转换规则"><a href="#隐式转换规则" class="headerlink" title="隐式转换规则"></a>隐式转换规则</h2><h3 id="标记规则-Marking-Rule"><a href="#标记规则-Marking-Rule" class="headerlink" title="标记规则(Marking Rule)"></a>标记规则(Marking Rule)</h3><p>任何变量，函数或者对象都可以用implicit这个关键字进行标记，表示可以进行隐式转换。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">intToString</span></span>(x: <span class="type">Int</span>) = x.toString</span><br></pre></td></tr></table></figure>
<p>编译器可能会将x + y 转换成 convert(x) + y 如果convert被标记成implicit。<br>同样只有哪些使用 implicit 关键字的定义才是可以使用的隐式定义。<strong>关键字 implicit 用来标记一个隐式定义</strong>。编译器才可以选择它作为隐式变化的候选项。你可以使用 implicit 来标记任意变量，函数或是对象。</p>
<h3 id="作用域规则-Scope-Rule"><a href="#作用域规则-Scope-Rule" class="headerlink" title="作用域规则(Scope Rule)"></a>作用域规则(Scope Rule)</h3><p>在一个作用域内，一个隐式转换必须是一个唯一的标识。</p>
<p>比如说MyUtils这个object里有很多隐式转换。x + y 不会使用MyUtils里的隐式转换。 除非import进来。 import MyUtils._</p>
<p>Scala编译器还能在companion class中去找companion object中定义的隐式转换。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">    <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">getClub</span></span>(player: <span class="type">Player</span>): <span class="type">Club</span> = <span class="type">Club</span>(player.clubName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span>(<span class="params">val name: <span class="type">String</span>, val age: <span class="type">Int</span>, val clubName: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> p = <span class="keyword">new</span> <span class="type">Player</span>(<span class="string">"costa"</span>, <span class="number">27</span>, <span class="string">"Chelsea"</span>)</span><br><span class="line"></span><br><span class="line">println(p.welcome) <span class="comment">// Chelsea welcome you here!</span></span><br><span class="line">println(p.playerNum) <span class="comment">// 21</span></span><br></pre></td></tr></table></figure>
<h3 id="一次编译只隐式转换一次-One-at-a-time-Rule"><a href="#一次编译只隐式转换一次-One-at-a-time-Rule" class="headerlink" title="一次编译只隐式转换一次(One-at-a-time Rule)"></a>一次编译只隐式转换一次(One-at-a-time Rule)</h3><p>Scala不会把 x + y 转换成 convert1(convert2(x)) + y</p>
<h2 id="隐式转换类型"><a href="#隐式转换类型" class="headerlink" title="隐式转换类型"></a>隐式转换类型</h2><h3 id="隐式转换成正确的类型"><a href="#隐式转换成正确的类型" class="headerlink" title="隐式转换成正确的类型"></a>隐式转换成正确的类型</h3><p>这种类型是Scala编译器对隐式转换的第一选择。 比如说编译器看到一个类型的X的数据，但是需要一个类型为Y的数据，那么就会去找把X类型转换成Y类型的隐式转换。</p>
<p>本文一开始的double2Int方法就是这种类型的隐式转换。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">double2Int</span></span>(d: <span class="type">Double</span>) = d.toInt</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> num: <span class="type">Int</span> = <span class="number">3.5</span> <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>当编译器发现变量num是个Int类型，并且用Double类型给它赋值的时候，会报错。 但是在报错之前，编译器会查找Double =&gt; Int的隐式转换。然后发现了double2Int这个隐式转换函数。于是就使用了隐式转换。</p>
<h3 id="方法调用的隐式转换"><a href="#方法调用的隐式转换" class="headerlink" title="方法调用的隐式转换"></a>方法调用的隐式转换</h3><p>比如这段代码 obj.doSomeThing。 比如obj对象没有doSomeThing这个方法，编译器会会去查找拥有doSomeThing方法的类型，并且看obj类型是否有隐式转换成有doSomeThing类型的函数。有的话就是将obj对象隐式转换成拥有doSomeThing方法的对象。</p>
<p>以下是一个例子：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">+</span></span>(num: <span class="type">Int</span>) = age + num</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">+</span></span>(p: <span class="type">Person</span>) = age + p.age</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> person = <span class="type">Person</span>(<span class="string">"format"</span>, <span class="number">99</span>)</span><br><span class="line">println(person + <span class="number">1</span>) <span class="comment">// 100</span></span><br><span class="line"><span class="comment">//  println(1 + person)  报错，因为Int的+方法没有有Person参数的重载方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">personAddAge</span></span>(x: <span class="type">Int</span>) = <span class="type">Person</span>(<span class="string">"unknown"</span>, x)</span><br><span class="line"></span><br><span class="line">println(<span class="number">1</span> + person) <span class="comment">// 100</span></span><br></pre></td></tr></table></figure>
<p>**<br>有了隐式转换方法之后，编译器检查 1 + person 表达式，发现Int的+方法没有有Person参数的重载方法。在放弃之前查看是否有将Int类型的对象转换成以Person为参数的+方法的隐式转换函数，于是找到了，然后就进行了隐式转换。</p>
<p>Scala的Predef中也使用了方法调用的隐式转换。</p>
<p>Map(1 -&gt; 11, 2 -&gt; 22)<br>上面这段Map中的参数是个二元元组。 Int没有 -&gt; 方法。 但是在Predef中定义了：</p>
<p>implicit final class ArrowAssoc<a href="private val self: A">A</a> extends AnyVal {<br>    @inline def -&gt; <a href="y: B" target="_blank" rel="noopener">B</a>: Tuple2[A, B] = Tuple2(self, y)<br>    def →<a href="y: B" target="_blank" rel="noopener">B</a>: Tuple2[A, B] = -&gt;(y)<br>}</p>
<h2 id="隐式参数"><a href="#隐式参数" class="headerlink" title="隐式参数"></a>隐式参数</h2><p><strong>隐式参数的意义是当方法需要多个参数的时候，可以定义一些隐式参数，这些隐式参数可以被自动加到方法填充的参数里，而不必手填充</strong>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">implicitParamFunc</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> tiger: <span class="type">Tiger</span>, lion: <span class="type">Lion</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    println(name + <span class="string">" have a tiget and a lion, their names are: "</span> + tiger.name + <span class="string">", "</span> + lion.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Zoo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> tiger = <span class="type">Tiger</span>(<span class="string">"tiger1"</span>)</span><br><span class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> lion = <span class="type">Lion</span>(<span class="string">"lion1"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="type">Zoo</span>._</span><br><span class="line"></span><br><span class="line">implicitParamFunc(<span class="string">"format"</span>)</span><br></pre></td></tr></table></figure>
<p>上面这个代码中implicitParamFunc中的第二个参数定义成了隐式参数。</p>
<p>然后在Zoo对象里定义了两个隐式变量，import进来之后，调用implicitParamFunc方法的时候这两个变量被自动填充到了参数里。</p>
<p>这里需要注意的是<strong>不仅仅方法中的参数需要被定义成隐式参数，对应的隐式参数的变量也需要被定义成隐式变量</strong>。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>对象中的隐式转换可以只import自己需要的。</p>
<p>object MyUtils {<br>    implicit def a …<br>    implicit def b …<br>}</p>
<p>import MyUtils.a<br>隐式转换修饰符implicit可以修饰class，method，变量，object。</p>
<p>修饰方法和变量的隐式转换本文已经介绍过，就不继续说了。</p>
<p>修饰class的隐式转换，它的作用跟修饰method的隐式转换类似：</p>
<p>implicit class RangeMarker(val start: Int) {<br>    def –&gt;(end: Int) = start to end<br>}</p>
<p>1 –&gt; 10 // Range(1, 10)<br>上段代码可以改造成使用Value Class完成类的隐式转换：</p>
<p>implicit class RangeMaker(start: Int) extends AnyVal {<br>    def –&gt;(end: Int) = start to end<br>}<br>修饰object的隐式转换：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Calculate</span>[<span class="type">T</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(x: <span class="type">T</span>, y: <span class="type">T</span>): <span class="type">T</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">object</span> <span class="title">IntCal</span> <span class="keyword">extends</span> <span class="title">Calculate</span>[<span class="type">Int</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="class"><span class="keyword">object</span> <span class="title">ListCal</span> <span class="keyword">extends</span> <span class="title">Calculate</span>[<span class="type">List</span>[<span class="type">Int</span>]] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(x: <span class="type">List</span>[<span class="type">Int</span>], y: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = x ::: y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">implicitObjMethod</span></span>[<span class="type">T</span>](x: <span class="type">T</span>, y: <span class="type">T</span>)(<span class="keyword">implicit</span> cal: <span class="type">Calculate</span>[<span class="type">T</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    println(x + <span class="string">" + "</span> + y + <span class="string">" = "</span> + cal.add(x, y))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">implicitObjMethod(<span class="number">1</span>, <span class="number">2</span>) <span class="comment">// 1 + 2 = 3</span></span><br><span class="line">implicitObjMethod(<span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="type">List</span>(<span class="number">3</span>, <span class="number">4</span>)) <span class="comment">// List(1, 2) + List(3, 4) = List(1, 2, 3, 4)</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/05/12/Spark如何处理异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/12/Spark如何处理异常/" itemprop="url">Spark如何处理异常</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-12T17:07:52+08:00">
                2017-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="异步执行和异常处理"><a href="#异步执行和异常处理" class="headerlink" title="异步执行和异常处理"></a>异步执行和异常处理</h2><p>Spark使用RDD作为基本单元来构建基于大量数据的算法.</p>
<p>在RDD上你有两个操作:转换 transformation和行动 actions.转换操作会通过前一个RDD构建一个新的RDD.比如map和flatMap.<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> lines:<span class="type">RDD</span>[<span class="type">String</span>]=sc.textFile(<span class="string">"large_file.txt"</span>)</span><br><span class="line"><span class="keyword">val</span> tokens = lines.flatMap(_ split <span class="string">" "</span>)</span><br></pre></td></tr></table></figure></p>
<p>而行动操作则基于RDD计算结果出来.然后返回给驱动程序或者保存到外部的存储系统(HDFS,HBase)等<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tokens.saveAsTextFile(<span class="string">"/some/uotput/file.txt"</span>)</span><br></pre></td></tr></table></figure></p>
<p>最后,关于RDD, 你需要记住: <figure class="highlight plain"><figcaption><span>you can define new RDDs any time, Spark computes them only in a lazy fashion —that is, the first time they are used in an action. ```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在RDD上处理转换操作的时候, 可能会出错和抛出异常.通常的处理方法就是把转换操作用try-catch包裹起来</span><br><span class="line">``` scala</span><br><span class="line">val lines: RDD[String] = sc.textFile(&quot;large_file.txt&quot;)</span><br><span class="line">try &#123;</span><br><span class="line">    val tokens = lines.flatMap(_ split &quot; &quot;)</span><br><span class="line">     // This transformation can throw an exception</span><br><span class="line">     .map(s =&gt; s(10))</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    case e : StringIndexOutOfBoundsException =&gt; </span><br><span class="line">    // Doing something in response of the exception</span><br><span class="line">&#125;</span><br><span class="line">tokens.saveAsTextFile(&quot;/some/output/file.txt&quot;)</span><br></pre></td></tr></table></figure></p>
<p>不幸的是, 转换里的代码直到第一次行动 执行时才会真的执行.也就是说上面的处理异常的代码是完全无用的.我们能做的也就只能时把行动 操作用try-catch包裹起来<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> lines: <span class="type">RDD</span>[<span class="type">String</span>] = sc.textFile(<span class="string">"large_file.txt"</span>)</span><br><span class="line"><span class="keyword">val</span> tokens = </span><br><span class="line">    lines.flatMap(_ split <span class="string">" "</span>)</span><br><span class="line">    .map(s =&gt; s(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// This try-catch block catch all the exceptions thrown by the </span></span><br><span class="line">    <span class="comment">// preceding transformations. </span></span><br><span class="line">    tokens.saveAsTextFile(<span class="string">"/some/output/file.txt"</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e : <span class="type">StringIndexOutOfBoundsException</span> =&gt; </span><br><span class="line">    <span class="comment">// Doing something in response of the exception</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你可以看到,我们丢失了异常处理的位置</p>
<p>使用这种方法,我们会丢失抛出异常的元素.此外,Spark是用来处理大量数据的:我们能确定我们的目的就是仅仅因为一个RDD里一个元素的错误就要阻塞整个执行过程吗?</p>
<h2 id="函数式编程和异常处理"><a href="#函数式编程和异常处理" class="headerlink" title="函数式编程和异常处理"></a>函数式编程和异常处理</h2><p>第二种处理方法则是将try-catch移动到转换 操作中. 以上代码变为:</p>
<p>val tokens =<br>    lines.flatMap(_ split “ “)<br>       .map {<br>         s =&gt; try {<br>             s(10)<br>           } catch {<br>              case e : StringIndexOutOfBoundsException =&gt;<br>                // What the hell can we return in this case?<br>           }<br>       }   // end of map<br>通过这么做,我们重新获得了位置 特征! 但是,通过这种方法,我们又引入了另一个问题.先前说过: 一个转换操作从旧的RDD里构建了一个新的RDD.转换操作map的偏函数输入的原始类型是String=&gt;Char</p>
<p>为了保留这个特征,我们不得不在case语句中返回一个Char或他的子类型.我们该怎么选择?空的字符?一个特殊的字符? 这些选择显然迟早会造成其他的问题.<br>对于Spark Transformation算子中的异常处理，直接写try catch会导致需要添加很多额外的代码。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> data = <span class="type">Seq</span>(<span class="string">"123"</span>, <span class="string">"12aa"</span>)</span><br><span class="line">  <span class="keyword">val</span> dataRDD = sc.parallelize(data)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> intRDD = dataRDD.map &#123;</span><br><span class="line">    item =&gt;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        item.toInt</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">NumberFormatException</span> =&gt;</span><br><span class="line">          <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;.collect()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> anotherRDD = dataRDD.map &#123;</span><br><span class="line">  item =&gt;</span><br><span class="line">    <span class="type">Try</span>(item.toInt)</span><br><span class="line">&#125;.filter(_.isSuccess).collect()</span><br><span class="line">anotherRDD.foreach(println)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/05/04/谈谈Spark的计算本地性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/04/谈谈Spark的计算本地性/" itemprop="url">谈谈Spark的计算本地性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-04T10:51:46+08:00">
                2017-05-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载：<a href="http://coolplayer.net/2017/05/02/%E8%B0%88%E8%B0%88spark-%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%AC%E5%9C%B0%E6%80%A7" target="_blank" rel="noopener">http://coolplayer.net/2017/05/02/%E8%B0%88%E8%B0%88spark-%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%AC%E5%9C%B0%E6%80%A7</a></p>
<p>Spark 是计算追着数据走， Storm 是数据追着计算走， 所以如果数据量比较小，要求延迟比较小， 就适合storm， 但是如果数据量比较大， 这个时候如果传输数据， 就会碰到很大的带宽占用和性能下降， 这个时候就比较适合让计算去找数据.</p>
<p>但是在计算找数据的过程中， 是怎么让计算找到数据呢， 这个就是这篇文章谈的， spark 的计算本地性</p>
<p><img src="http://7xim8y.com1.z0.glb.clouddn.com/local1.jpg" alt=""></p>
<h2 id="不同的-Locality-Level"><a href="#不同的-Locality-Level" class="headerlink" title="不同的 Locality Level"></a>不同的 Locality Level</h2><ul>
<li>PROCESS_LOCAL: 数据和 task 在同一个executor jvm 中，最好的就是这种 locality。</li>
<li>NODE_LOCAL: 数据在同一个节点上。比如数据在同一个节点的另一个 executor上；或在 HDFS 上，恰好有 block 在同一个节点上。速度比 PROCESS_LOCAL 稍慢，因为数据需要在不同进程之间传递或从文件中读取</li>
<li>NO_PREF: 数据从哪里访问都一样快，不需要位置优先</li>
<li>RACK_LOCAL: 数据在同一机架的不同节点上。需要通过网络传输数据及文件 IO，比 NODE_LOCAL 慢</li>
<li>ANY: 数据在非同一机架的网络上，速度最慢</li>
</ul>
<p><img src="http://7xim8y.com1.z0.glb.clouddn.com/local2.jpg" alt=""></p>
<h2 id="Task-自己想在哪里执行"><a href="#Task-自己想在哪里执行" class="headerlink" title="Task 自己想在哪里执行"></a>Task 自己想在哪里执行</h2><p>我们来看下 task 自己想在哪里执行， 这要根据 task 处理的数据是否缓存， task 的数据所在的 host 和 rack来判断， 在 DAGScheduler 中， 每个分区每个 stage 会成为一个task， 每个 task 会根据自己分区的数据的情况，进行判断自己的 本地性Level，</p>
<p>getPreferredLocs -&gt; getPreferredLocsInternal</p>
<p>函数中， 会先判断是否rdd 本分区的数据是否已经缓存在 blockManager， 如果已经缓存， 获取到数据所在的 host 和 executorId， 然后设置本 task 的数据本地性 Level 为 PROCESS_LOCAL， 偏好某个 host 上的某个 executor 去执行，</p>
<p>如果没有缓存， 那么就不能是PROCESS_LOCAL ， 最多也就是个 NODE_LOCAL，会根据不同的RDD类型，来调用具体的 getPreferredLocations 来判断数据本地性 Level， 和数据本地性偏好</p>
<p>假如这里是HadoopRDD， 那么每个 task 处理的数据就是一个 HadoopPartition， 其实代表 hdfs 中的一份数据 InputSplit， 它定义了分割的长度及位置。分割长度 是指分割数据的大小（以字节为单位），而分割位置 是分割所在的机器结点名称组成的列表， 分割位置中就能获取到 数据所在的 host 和 rack，</p>
<p>如果数据源头是 kafka， 那么每个 task 处理的数据就是 KafkaRDDPartition， 其实对应每一个topic的每一个partition， preferredHosts 中记录着每个 topic 中每个 partition 所在的 host， 就直接可以当做 偏好的 host， 如果kafka中broker和Spark在同一个集群中，此时getPreferredLocations获取本地性就可以极大提高效率，因为没有了数据网络传输的成本。</p>
<p>以上两种都偏好某个 host 去执行</p>
<p>这里需要注意的是，这里找的数据源头是 rdd的顺着窄依赖， 往上找父依赖， 直到找到第一个窄依赖， 也就找到了数据读取源头， 来决定数据本地性</p>
<p>如果读取的是 shuffle 的数据， 就不用考虑那么多了， 因为shuffle中的read task 是需要去所有的write task的disk上拉取数据的。</p>
<h2 id="怎么能最大程度的满足-task-的本地性"><a href="#怎么能最大程度的满足-task-的本地性" class="headerlink" title="怎么能最大程度的满足 task 的本地性"></a>怎么能最大程度的满足 task 的本地性</h2><p>我们都知道， 数据传输对内网带宽和性能有极大的损耗，所以要千方百计的最大程度的满足 更高级别的本地性，从优到差排， PROCESS_LOCAL &gt; NODE_LOCAL &gt; NO_PREF &gt; RACK_LOCAL</p>
<p>所以spark 调度的总体原则就是总是尝试以最高的 locality level 去启动task， 如果对应需要是用到的 executor 正在使用中（跑别的task），满足不了， 就等一会（等待时间是有spark.locality.wait.process或spark.locality.wait.node或spark.locality.wait.rack来控制的）， 看看过一会这个忙线的host 或者 executor是不是解脱了， 如果已经空闲了，我就可以把 task 放在它最期望的 host 或者 executor 上去运行了， 这里赌的就是一般来说，task 执行耗时相对于网络传输/文件IO 要小得多，调度器多等待1 2秒可能就可以以更好的本地性执行 task，避免了更耗时的网络传输或文件IO， 也是极棒的。</p>
<h2 id="Spark的延迟调度"><a href="#Spark的延迟调度" class="headerlink" title="Spark的延迟调度"></a>Spark的延迟调度</h2><p>我们来看下 spark 的延迟调度的策略，</p>
<p>有时候 task 自己偏好某个 executor 中，</p>
<p>可以看下面的图直观理解一下</p>
<p><img src="http://7xim8y.com1.z0.glb.clouddn.com/local3.jpg" alt=""></p>
<p>所以spark 调度的总体原则就是总是尝试以最高的 locality level 去启动task，<br>我举个例子， 假如 一个 task 要处理的数据，在上一个 stage 中缓存下来了， 这个 task 期望的 就是以 PROCESS_LOCAL 来运行， 这个时候缓存数据的executor 不巧正在执行 其他的task， 那么我就等一会， 等多长时间呢， spark.locality.wait.process这么长时间， 如果时间超了， executor 还是没有空闲下来， 那么我没有办法， 我就以NODE_LOCAL 来运行 task， 这个时候我想到 同一台机器上其他 executor 上跨jvm 去拉取数据， 如果同一台机器上有其他空闲的 executor 可以满足， 就这么干， 如果没有， 等待 spark.locality.wait.node 时间， 还没有就以更低的 Locality Level 去执行这个 task。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://slamke.github.io/2017/04/13/如何重构箭头型代码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Ke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雁渡寒潭 风吹疏竹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/13/如何重构箭头型代码/" itemprop="url">如何重构箭头型代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-13T10:37:03+08:00">
                2017-04-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/重构/" itemprop="url" rel="index">
                    <span itemprop="name">重构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载自： <a href="http://coolshell.cn/articles/17757.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="noopener">http://coolshell.cn/articles/17757.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>
<p>本文主要起因是，一次在微博上和朋友关于嵌套好几层的if-else语句的代码重构的讨论，在微博上大家有各式各样的问题和想法。按道理来说这些都是编程的基本功，似乎不太值得写一篇文章，不过我觉得很多东西可以从一个简单的东西出发，到达本质，所以，我觉得有必要在这里写一篇的文章。不一定全对，只希望得到更多的讨论，因为有了更深入的讨论才能进步。</p>
<p>文章有点长，我在文章最后会给出相关的思考和总结陈词，你可以跳到结尾。</p>
<p>所谓箭头型代码，基本上来说就是下面这个图片所示的情况。</p>
<p><img src="http://coolshell.cn//wp-content/uploads/2017/04/IMG_7411.jpg" alt=""></p>
<p>那么，这样“箭头型”的代码有什么问题呢？看上去也挺好看的，有对称美。但是……</p>
<p>关于箭头型代码的问题有如下几个：</p>
<p>1）我的显示器不够宽，箭头型代码缩进太狠了，需要我来回拉水平滚动条，这让我在读代码的时候，相当的不舒服。</p>
<p>2）除了宽度外还有长度，有的代码的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">总而言之，**“箭头型代码”如果嵌套太多，代码太长的话，会相当容易让维护代码的人（包括自己）迷失在代码中，因为看到最内层的代码时，你已经不知道前面的那一层一层的条件判断是什么样的，代码是怎么运行到这里的，所以，箭头型代码是非常难以维护和Debug的**。</span><br><span class="line"></span><br><span class="line">## 微博上的案例 与 Guard Clauses</span><br><span class="line">OK，我们先来看一下微博上的那个示例，代码量如果再大一点，嵌套再多一点，你很容易会在条件中迷失掉（下面这个示例只是那个“大箭头”下的一个小箭头）</span><br><span class="line">``` java</span><br><span class="line">FOREACH(Ptr&lt;WfExpression&gt;, argument, node-&gt;arguments) &#123;</span><br><span class="line">    int index = manager-&gt;expressionResolvings.Keys().IndexOf(argument.Obj());</span><br><span class="line">    if (index != -1) &#123;</span><br><span class="line">        auto type = manager-&gt;expressionResolvings.Values()[index].type;</span><br><span class="line">        if (! types.Contains(type.Obj())) &#123;</span><br><span class="line">            types.Add(type.Obj());</span><br><span class="line">            if (auto group = type-&gt;GetTypeDescriptor()-&gt;GetMethodGroupByName(L&quot;CastResult&quot;, true)) &#123;</span><br><span class="line">                int count = group-&gt;GetMethodCount();</span><br><span class="line">                for (int i = 0; i &lt; count; i++) &#123; auto method = group-&gt;GetMethod(i);</span><br><span class="line">                    if (method-&gt;IsStatic()) &#123;</span><br><span class="line">                        if (method-&gt;GetParameterCount() == 1 &amp;&amp;</span><br><span class="line">                            method-&gt;GetParameter(0)-&gt;GetType()-&gt;GetTypeDescriptor() == description::GetTypeDescriptor&lt;DescriptableObject&gt;() &amp;&amp;</span><br><span class="line">                            method-&gt;GetReturn()-&gt;GetTypeDescriptor() != description::GetTypeDescriptor&lt;void&gt;() ) &#123;</span><br><span class="line">                            symbol-&gt;typeInfo = CopyTypeInfo(method-&gt;GetReturn());</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面这段代码，可以把条件反过来写，然后就可以把箭头型的代码解掉了，重构的代码如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FOREACH(Ptr&lt;WfExpression&gt;, argument, node-&gt;arguments) &#123;</span><br><span class="line">    <span class="keyword">int</span> index = manager-&gt;expressionResolvings.Keys().IndexOf(argument.Obj());</span><br><span class="line">    <span class="keyword">if</span> (index == -<span class="number">1</span>)  <span class="keyword">continue</span>;</span><br><span class="line">     </span><br><span class="line">    auto type = manager-&gt;expressionResolvings.Values()[index].type;</span><br><span class="line">    <span class="keyword">if</span> ( types.Contains(type.Obj()))  <span class="keyword">continue</span>;</span><br><span class="line">     </span><br><span class="line">    types.Add(type.Obj());</span><br><span class="line"> </span><br><span class="line">    auto group = type-&gt;GetTypeDescriptor()-&gt;GetMethodGroupByName(L<span class="string">"CastResult"</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span>  ( ! group ) <span class="keyword">continue</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> count = group-&gt;GetMethodCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123; auto method = group-&gt;GetMethod(i);</span><br><span class="line">        <span class="keyword">if</span> (! method-&gt;IsStatic()) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( method-&gt;GetParameterCount() == <span class="number">1</span> &amp;&amp;</span><br><span class="line">               method-&gt;GetParameter(<span class="number">0</span>)-&gt;GetType()-&gt;GetTypeDescriptor() == description::GetTypeDescriptor&lt;DescriptableObject&gt;() &amp;&amp;</span><br><span class="line">               method-&gt;GetReturn()-&gt;GetTypeDescriptor() != description::GetTypeDescriptor&lt;<span class="keyword">void</span>&gt;() ) &#123;</span><br><span class="line">            symbol-&gt;typeInfo = CopyTypeInfo(method-&gt;GetReturn());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这种代码的重构方式叫 Guard Clauses</p>
<p>Martin Fowler 的 Refactoring 的网站上有相应的说明《Replace Nested Conditional with Guard Clauses》。<br>Coding Horror 上也有一篇文章讲了这种重构的方式 —— 《Flattening Arrow Code》<br>StackOverflow 上也有相关的问题说了这种方式 —— 《Refactor nested IF statement for clarity》<br>这里的思路其实就是，<strong>让出错的代码先返回，前面把所有的错误判断全判断掉，然后就剩下的就是正常的代码了</strong>。</p>
<h2 id="抽取成函数"><a href="#抽取成函数" class="headerlink" title="抽取成函数"></a>抽取成函数</h2><p>微博上有些人说，continue 语句破坏了阅读代码的通畅，我觉得他们一定没有好好读这里面的代码，其实，我们可以看到，所有的 if 语句都是在判断是否出错的情况，所以，在维护代码的时候，你可以完全不理会这些 if 语句，因为都是出错处理的，而剩下的代码都是正常的功能代码，反而更容易阅读了。当然，一定有不是上面代码里的这种情况，那么，不用continue ，我们还能不能重构呢？</p>
<p>当然可以，抽成函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">bool <span class="title">CopyMethodTypeInfo</span><span class="params">(auto &amp;method, auto &amp;group, auto &amp;symbol)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! method-&gt;IsStatic()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( method-&gt;GetParameterCount() == <span class="number">1</span> &amp;&amp;</span><br><span class="line">           method-&gt;GetParameter(<span class="number">0</span>)-&gt;GetType()-&gt;GetTypeDescriptor() == description::GetTypeDescriptor&lt;DescriptableObject&gt;() &amp;&amp;</span><br><span class="line">           method-&gt;GetReturn()-&gt;GetTypeDescriptor() != description::GetTypeDescriptor&lt;<span class="keyword">void</span>&gt;() ) &#123;</span><br><span class="line">        symbol-&gt;typeInfo = CopyTypeInfo(method-&gt;GetReturn());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ExpressionResolvings</span><span class="params">(auto &amp;manager, auto &amp;argument, auto &amp;symbol)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index = manager-&gt;expressionResolvings.Keys().IndexOf(argument.Obj());</span><br><span class="line">    <span class="keyword">if</span> (index == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">     </span><br><span class="line">    auto type = manager-&gt;expressionResolvings.Values()[index].type;</span><br><span class="line">    <span class="keyword">if</span> ( types.Contains(type.Obj())) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    types.Add(type.Obj());</span><br><span class="line">    auto group = type-&gt;GetTypeDescriptor()-&gt;GetMethodGroupByName(L<span class="string">"CastResult"</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span>  ( ! group ) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> count = group-&gt;GetMethodCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123; auto method = group-&gt;GetMethod(i);</span><br><span class="line">        <span class="keyword">if</span> ( ! CopyMethodTypeInfo(method, group, symbol) ) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">FOREACH(Ptr&lt;WfExpression&gt;, argument, node-&gt;arguments) &#123;</span><br><span class="line">    ExpressionResolvings(manager, arguments, symbol)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>你发出现，抽成函数后，代码比之前变得更容易读和更容易维护了。不是吗？</p>
<p>有人说：“如果代码不共享，就不要抽取成函数！”，持有这个观点的人太死读书了。函数是代码的封装或是抽象，并不一定用来作代码共享使用，函数用于屏蔽细节，让其它代码耦合于接口而不是细节实现，这会让我们的代码更为简单，简单的东西都能让人易读也易维护。这才是函数的作用。</p>
<h2 id="嵌套的-if-外的代码"><a href="#嵌套的-if-外的代码" class="headerlink" title="嵌套的 if 外的代码"></a>嵌套的 if 外的代码</h2><p>微博上还有人问，原来的代码如果在各个 if 语句后还有要执行的代码，那么应该如何重构。比如下面这样的代码。</p>
<p>原版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(....) &#123;</span><br><span class="line">    do_before_cond1()</span><br><span class="line">    <span class="keyword">if</span> (cond1) &#123;</span><br><span class="line">        do_before_cond2();</span><br><span class="line">        <span class="keyword">if</span> (cond2) &#123;</span><br><span class="line">            do_before_cond3();</span><br><span class="line">            <span class="keyword">if</span> (cond3) &#123;</span><br><span class="line">                do_something();</span><br><span class="line">            &#125;</span><br><span class="line">            do_after_cond3();</span><br><span class="line">        &#125;</span><br><span class="line">        do_after_cond2();</span><br><span class="line">    &#125;</span><br><span class="line">    do_after_cond1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面这段代码中的那些 <strong>do_after_condX()</strong> 是无论条件成功与否都要执行的。所以，我们拉平后的代码如下所示：</p>
<p>重构第一版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(....) &#123;</span><br><span class="line">    do_before_cond1();</span><br><span class="line">    <span class="keyword">if</span> ( !cond1 ) &#123;</span><br><span class="line">        do_after_cond1();</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    &#125; </span><br><span class="line">    do_after_cond1();</span><br><span class="line"> </span><br><span class="line">    do_before_cond2();</span><br><span class="line">    <span class="keyword">if</span> ( !cond2 ) &#123; </span><br><span class="line">        do_after_cond2();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    do_after_cond2();</span><br><span class="line"> </span><br><span class="line">    do_before_cond3();</span><br><span class="line">    <span class="keyword">if</span> ( !cond3 ) &#123;</span><br><span class="line">        do_after_cond3();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    do_after_cond3();</span><br><span class="line"> </span><br><span class="line">    do_something();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你会发现，上面的 do_after_condX 出现了两份。<strong>如果 if 语句块中的代码改变了某些do_after_condX依赖的状态，那么这是最终版本</strong>。</p>
<p>但是，如果它们之前没有依赖关系的话，根据 DRY 原则，我们就可以只保留一份，那么直接掉到 if 条件前就好了，如下所示：</p>
<p>重构第二版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(....) &#123;</span><br><span class="line">    do_before_cond1();</span><br><span class="line">    do_after_cond1();</span><br><span class="line">    <span class="keyword">if</span> ( !cond1 ) <span class="keyword">continue</span>;</span><br><span class="line">  </span><br><span class="line">    do_before_cond2();</span><br><span class="line">    do_after_cond2();</span><br><span class="line">    <span class="keyword">if</span> ( !cond2 ) <span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">    do_before_cond3();</span><br><span class="line">    do_after_cond3();</span><br><span class="line">    <span class="keyword">if</span> ( !cond3 ) <span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">    do_something();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此时，你会说，我靠，居然，改变了执行的顺序，把条件放到 do_after_condX() 后面去了。这会不会有问题啊？</p>
<p>其实，你再分析一下之前的代码，你会发现，本来，cond1 是判断 do_before_cond1() 是否出错的，如果有成功了，才会往下执行。而 do_after_cond1() 是无论如何都要执行的。从逻辑上来说，do_after_cond1()其实和do_before_cond1()的执行结果无关，而 cond1 却和是否去执行 do_before_cond2() 相关了。如果我把断行变成下面这样，反而代码逻辑更清楚了。</p>
<p>重构第三版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(....) &#123;</span><br><span class="line"> </span><br><span class="line">    do_before_cond1();</span><br><span class="line">    do_after_cond1();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( !cond1 ) <span class="keyword">continue</span>;  <span class="comment">// &lt;-- cond1 成了是否做第二个语句块的条件</span></span><br><span class="line">    do_before_cond2();</span><br><span class="line">    do_after_cond2();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( !cond2 ) <span class="keyword">continue</span>; <span class="comment">// &lt;-- cond2 成了是否做第三个语句块的条件</span></span><br><span class="line">    do_before_cond3();</span><br><span class="line">    do_after_cond3();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( !cond3 ) <span class="keyword">continue</span>; <span class="comment">//&lt;-- cond3 成了是否做第四个语句块的条件</span></span><br><span class="line">    do_something(); </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>于是乎，在未来维护代码的时候，维护人一眼看上去就明白，代码在什么时候会执行到哪里。 这个时候，你会发现，把这些语句块抽成函数，代码会干净的更多，再重构一版：</p>
<p>重构第四版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">bool <span class="title">do_func3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   do_before_cond2();</span><br><span class="line">   do_after_cond2();</span><br><span class="line">   <span class="keyword">return</span> cond3;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">bool <span class="title">do_func2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   do_before_cond2();</span><br><span class="line">   do_after_cond2();</span><br><span class="line">   <span class="keyword">return</span> cond2;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">bool <span class="title">do_func1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   do_before_cond1();</span><br><span class="line">   do_after_cond1();</span><br><span class="line">   <span class="keyword">return</span> cond1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// for-loop 你可以重构成这样</span></span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    bool cond = do_func1();</span><br><span class="line">    <span class="keyword">if</span> (cond) cond = do_func2();</span><br><span class="line">    <span class="keyword">if</span> (cond) cond = do_func3();</span><br><span class="line">    <span class="keyword">if</span> (cond) do_something();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// for-loop 也可以重构成这样</span></span><br><span class="line"><span class="keyword">for</span> (...) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ! do_func1() ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ! do_func2() ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ! do_func3() ) <span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">   do_something();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面，我给出了两个版本的for-loop，你喜欢哪个？我喜欢第二个。这个时候，因为for-loop里的代码非常简单，就算你不喜欢 continue ，这样的代码阅读成本已经很低了。</p>
<h2 id="状态检查嵌套"><a href="#状态检查嵌套" class="headerlink" title="状态检查嵌套"></a>状态检查嵌套</h2><p>接下来，我们再来看另一个示例。下面的代码的伪造了一个场景——把两个人拉到一个一对一的聊天室中，因为要检查双方的状态，所以，代码可能会写成了“箭头型”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConnectPeer2Peer</span><span class="params">(Conn *pA, Conn* pB, Manager *manager)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( pA-&gt;isConnected() ) &#123;</span><br><span class="line">        manager-&gt;Prepare(pA);</span><br><span class="line">        <span class="keyword">if</span> ( pB-&gt;isConnected() ) &#123;</span><br><span class="line">            manager-&gt;Prepare(pB);</span><br><span class="line">            <span class="keyword">if</span> ( manager-&gt;ConnectTogther(pA, pB) ) &#123;</span><br><span class="line">                pA-&gt;Write(<span class="string">"connected"</span>);</span><br><span class="line">                pB-&gt;Write(<span class="string">"connected"</span>);</span><br><span class="line">                <span class="keyword">return</span> S_OK;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> S_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            pA-&gt;Write(<span class="string">"Peer is not Ready, waiting..."</span>);</span><br><span class="line">            <span class="keyword">return</span> S_RETRY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( pB-&gt;isConnected() ) &#123;</span><br><span class="line">            manager-&gt;Prepare();</span><br><span class="line">            pB-&gt;Write(<span class="string">"Peer is not Ready, waiting..."</span>);</span><br><span class="line">            <span class="keyword">return</span> S_RETRY;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            pA-&gt;Close();</span><br><span class="line">            pB-&gt;Close();</span><br><span class="line">            <span class="keyword">return</span> S_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Shouldn't be here!</span></span><br><span class="line">    <span class="keyword">return</span> S_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重构上面的代码，我们可以先分析一下上面的代码，说明了，上面的代码就是对 PeerA 和 PeerB 的两个状态 “连上”， “未连上” 做组合 “状态” （注：实际中的状态应该比这个还要复杂，可能还会有“断开”、“错误”……等等状态）， 于是，我们可以把代码写成下面这样，合并上面的嵌套条件，对于每一种组合都做出判断。这样一来，逻辑就会非常的干净和清楚。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ConnectPeer2Peer</span><span class="params">(Conn *pA, Conn* pB, Manager *manager)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( pA-&gt;isConnected() ) &#123;</span><br><span class="line">        manager-&gt;Prepare(pA);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( pB-&gt;isConnected() ) &#123;</span><br><span class="line">        manager-&gt;Prepare(pB);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// pA = YES &amp;&amp; pB = NO</span></span><br><span class="line">    <span class="keyword">if</span> (pA-&gt;isConnected() &amp;&amp; ! pB-&gt;isConnected()  ) &#123;</span><br><span class="line">        pA-&gt;Write(<span class="string">"Peer is not Ready, waiting"</span>);</span><br><span class="line">        <span class="keyword">return</span> S_RETRY;</span><br><span class="line">    <span class="comment">// pA = NO &amp;&amp; pB = YES</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ( !pA-&gt;isConnected() &amp;&amp; pB-&gt;isConnected() ) &#123;</span><br><span class="line">        pB-&gt;Write(<span class="string">"Peer is not Ready, waiting"</span>);</span><br><span class="line">        <span class="keyword">return</span> S_RETRY;</span><br><span class="line">    <span class="comment">// pA = YES &amp;&amp; pB = YES</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (pA-&gt;isConnected() &amp;&amp; pB-&gt;isConnected()  ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( ! manager-&gt;ConnectTogther(pA, pB) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> S_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        pA-&gt;Write(<span class="string">"connected"</span>);</span><br><span class="line">        pB-&gt;Write(<span class="string">"connected"</span>);</span><br><span class="line">        <span class="keyword">return</span> S_OK;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// pA = NO, pB = NO</span></span><br><span class="line">    pA-&gt;Close();</span><br><span class="line">    pB-&gt;Close();</span><br><span class="line">    <span class="keyword">return</span> S_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="延伸思考"><a href="#延伸思考" class="headerlink" title="延伸思考"></a>延伸思考</h2><p>对于<strong> if-else</strong> 语句来说，一般来说，就是检查两件事：<strong>错误</strong> 和 <strong>状态</strong>。</p>
<p>检查错误</p>
<p>对于检查错误来说，使用 Guard Clauses 会是一种标准解，但我们还需要注意下面几件事：</p>
<p>1）当然，出现错误的时候，还会出现需要释放资源的情况。你可以使用 <code>goto fail</code>; 这样的方式，但是最优雅的方式应该是C++面向对象式的 RAII 方式。</p>
<p>2）以错误码返回是一种比较简单的方式，这种方式有很一些问题，比如，如果错误码太多，判断出错的代码会非常复杂，另外，正常的代码和错误的代码会混在一起，影响可读性。所以，在更为高组的语言中，使用<code>try-catch</code>异常捕捉的方式，会让代码更为易读一些。</p>
<p><strong>检查状态</strong></p>
<p>对于检查状态来说，实际中一定有更为复杂的情况，比如下面几种情况：</p>
<p>1）像TCP协议中的两端的状态变化。</p>
<p>2）像shell各个命令的命令选项的各种组合。</p>
<p>3）像游戏中的状态变化（一棵非常复杂的状态树）。</p>
<p>4）像语法分析那样的状态变化。</p>
<p>对于这些复杂的状态变化，其本上来说，你需要先定义一个状态机，或是一个子状态的组合状态的查询表，或是一个状态查询分析树。</p>
<p><strong>写代码时，代码的运行中的控制状态或业务状态是会让你的代码流程变得混乱的一个重要原因，重构“箭头型”代码的一个很重要的工作就是重新梳理和描述这些状态的变迁关系。</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>好了，下面总结一下，把“箭头型”代码重构掉的几个手段如下：</p>
<p>1）<strong>使用 Guard Clauses</strong> 。 尽可能的让出错的先返回， 这样后面就会得到干净的代码。</p>
<p>2）<strong>把条件中的语句块抽取成函数</strong>。 有人说：“如果代码不共享，就不要抽取成函数！”，持有这个观点的人太死读书了。函数是代码的封装或是抽象，并不一定用来作代码共享使用，函数用于屏蔽细节，让其它代码耦合于接口而不是细节实现，这会让我们的代码更为简单，简单的东西都能让人易读也易维护，<strong>写出让人易读易维护的代码才是重构代码的初衷</strong>！</p>
<p>3）<strong>对于出错处理，使用try-catch异常处理和RAII机制</strong>。返回码的出错处理有很多问题，比如：A) 返回码可以被忽略，B) 出错处理的代码和正常处理的代码混在一起，C) 造成函数接口污染，比如像atoi()这种错误码和返回值共用的糟糕的函数。</p>
<p>4）对于多个状态的判断和组合，如果复杂了，可以使用“组合状态表”，或是状态机加Observer的状态订阅的设计模式。这样的代码即解了耦，也干净简单，同样有很强的扩展性。</p>
<p>5） 重构“箭头型”代码其实是在帮你重新梳理所有的代码和逻辑，这个过程非常值得为之付出。重新整思路去想尽一切办法简化代码的过程本身就可以让人成长。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sun Ke</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">98</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sun Ke</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
